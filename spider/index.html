<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Spider - Palp 中文文档</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Spider";
        var mkdocs_page_input_path = "spider.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Palp 中文文档
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../command/">Command</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Spider</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#localspider">LocalSpider</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_1">创建</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_2">结构</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#distributivespider">DistributiveSpider</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_3">创建</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_4">结构</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#borrow_requestrecycle_request">borrow_request、recycle_request</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#settings">settings 开启</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#spider_1">spider 回收</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#middleware">middleware 判断</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#_5">案例</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cyclespider">CycleSpider</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_6">创建</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_7">设置</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_8">结构</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#task_id">task_id</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#cyclespiderrecordmiddleware">CycleSpiderRecordMiddleware</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#jumpspider">JumpSpider</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_9">创建</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_10">使用</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#_11">启动爬虫</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#_12">爬虫内启动</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#_13">启动文件启动</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../database/">Database</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../middleware/">Middleware</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pipeline/">Pipeline</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../item/">Item</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../request/">Request</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../response/">Response</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tool/">Tool</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../other/">Other</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Palp 中文文档</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Spider</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="spider">Spider</h1>
<p>目前提供以下 spider</p>
<ul>
<li>LocalSpider：本地爬虫</li>
<li>DistributiveSpider：分布式爬虫</li>
<li>CycleSpider：周期爬虫（根据需求可继承本地、分布式）</li>
<li>JumpSpider：跳转爬虫（基于内存队列，用于频繁的验证码、登录的确认更新 cookie）</li>
</ul>
<h2 id="localspider">LocalSpider</h2>
<p>本地爬虫，不支持分布式</p>
<h3 id="_1">创建</h3>
<p>注意：在项目目录下执行</p>
<pre><code>palp create -s baidu 1
</code></pre>
<h3 id="_2">结构</h3>
<pre><code>&quot;&quot;&quot;
Create on 2022-12-12 16:21:10.159221
----------
@summary:
----------
@author:
&quot;&quot;&quot;
import palp


class BaiduSpider(palp.LocalSpider):
    spider_name = &quot;baidu&quot;   # 自定义的名字
    spider_domains = []  # 允许通过的域名，默认不限制
    spider_settings = None  # 字典形式或导入形式的设置

    def start_requests(self) -&gt; None:
        &quot;&quot;&quot;
        起始函数

        :return:
        &quot;&quot;&quot;
        yield palp.RequestGet(&quot;https://www.baidu.com&quot;)

    def parse(self, request, response) -&gt; None:
        &quot;&quot;&quot;
        解析函数

        :param request:
        :param response:
        :return:
        &quot;&quot;&quot;
        print(response)


if __name__ == '__main__':
    BaiduSpider().start()

</code></pre>
<h2 id="distributivespider">DistributiveSpider</h2>
<p>注意：</p>
<ul>
<li>分布式爬虫，需要在设置中增加 redis 连接</li>
<li>分布式爬虫默认为优先级队列，本身具有去重的功能，如果有大量必要的重复请求，修改 settings.REQUEST_QUEUE_MODE = 1</li>
</ul>
<h3 id="_3">创建</h3>
<pre><code>palp create -s baidu 2
</code></pre>
<h3 id="_4">结构</h3>
<p>和普通的爬虫，只是继承类不同，无成本切换</p>
<pre><code>&quot;&quot;&quot;
Create on 2022-12-12 16:21:10.159221
----------
@summary:
----------
@author:
&quot;&quot;&quot;
import palp


class BaiduSpider(palp.DistributiveSpider):
    spider_name = &quot;baidu&quot;   # 自定义的名字
    spider_domains = []  # 允许通过的域名，默认不限制
    spider_settings = None  # 字典形式或导入形式的设置

    def start_requests(self) -&gt; None:
        &quot;&quot;&quot;
        起始函数

        :return:
        &quot;&quot;&quot;
        yield palp.RequestGet(&quot;https://www.baidu.com&quot;)

    def parse(self, request, response) -&gt; None:
        &quot;&quot;&quot;
        解析函数

        :param request:
        :param response:
        :return:
        &quot;&quot;&quot;
        print(response)


if __name__ == '__main__':
    BaiduSpider().start()
</code></pre>
<h3 id="borrow_requestrecycle_request">borrow_request、recycle_request</h3>
<p>目前框架是根据以上两个函数实现 cookie_jar 共享功能（可自定义）</p>
<ul>
<li>borrow_request：决定在什么时候借用共享的参数</li>
<li>recycle_request：决定在执行完毕时，共享什么参数</li>
</ul>
<p>在处理批次任务时，可能一次会有很多任务，对每个任务都去重新请求，获取 cookie 的话（指的是登录、验证码等获取必要
cookie）将会是灾难</p>
<p>所以这里解决 cookie 复用，当然要做好 cookie 失效的判断，并重新登录（可在 middleware 判断，并直接返回含有
jumpspider 的请求）</p>
<h4 id="settings">settings 开启</h4>
<pre><code>REQUEST_BORROW = False  # 分发大量任务时，需要在请求中传递的参数（默认回收 cookie、meta 复用）
REQUEST_BORROW_DELETE_WHEN_START = True  # 启动时删除所有 BORROW（非分布式是在内存里，该选项忽略）
</code></pre>
<h4 id="spider_1">spider 回收</h4>
<p>因为 spider 内无法判断是否是最后一个请求，所以需要主动回收</p>
<pre><code>self.recycle_request(request=request)
</code></pre>
<h4 id="middleware">middleware 判断</h4>
<p>注意：这只是个案例</p>
<p>该案例是在请求结束时，判断到当前状态不对，随后修改请求，跳转登录，放弃原请求的同时，发出新的请求</p>
<pre><code>def request_close(self, spider, request, response):
    if response.status_code != 200:
        request.jump_spider = LoginJumpSpider
        request.jump_request_middleware = ProxyRequestMiddleware
        return request
</code></pre>
<h4 id="_5">案例</h4>
<pre><code>&quot;&quot;&quot;
Create on 2023-01-03 10:45:25.681820
----------
@summary:
----------
@author:
&quot;&quot;&quot;
import palp


class BaiduLocalSpider(palp.DistributiveSpider):
    spider_name = &quot;baidu&quot;  # 自定义的名字
    spider_domains = []  # 允许通过的域名，默认不限制
    spider_settings = None  # 字典形式或导入形式的设置

    def start_requests(self) -&gt; None:
        &quot;&quot;&quot;
        起始函数

        :return:
        &quot;&quot;&quot;
        yield palp.RequestGet(&quot;https://www.baidu.com&quot;, keep_cookie=True)
        yield palp.RequestGet(&quot;https://www.baidu.com&quot;, keep_cookie=True)

    def parse(self, request, response) -&gt; None:
        &quot;&quot;&quot;
        解析函数

        :param request:
        :param response:
        :return:
        &quot;&quot;&quot;
        print(request.cookie_jar.get_cookie())  # 可以看到两次是一样的 cookie
        self.recycle_request(request=request)


if __name__ == '__main__':
    BaiduLocalSpider(thread_count=1).start()

</code></pre>
<h2 id="cyclespider">CycleSpider</h2>
<p>周期爬虫，使用 mysql 创建任务表，并在爬虫内部获取进行抓取</p>
<p>个人认为，任务需求是多样化的，所以任务表的 task 字段是一个字符串，并且获取的任务是全表字段，这样就可以自定义部分表字段，实现更多需求</p>
<p>注意：</p>
<ul>
<li>继承周期爬虫的【同时需要继承 分布式 或 本地爬虫】才可以执行</li>
<li>手动导入中间件：palp.middleware.CycleSpiderRecordMiddleware（不需要 record 表，不需要传递 task_id 时框架设置已爬取，可以不要，自己维护就行了）</li>
<li>记录中间件会：自动修改失败、成功的任务状态（request 传递 task_id 时，或自己调用）</li>
<li>记录中间件会：自动在记录表中添加、修改任务执行情况</li>
</ul>
<p>含有以下方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>initialize_all_task_states</td>
<td>重置所有任务状态为 0</td>
</tr>
<tr>
<td>get_tasks</td>
<td>根据指定状态获取任务</td>
</tr>
<tr>
<td>get_tasks_state0</td>
<td>获取状态为 0 的任务</td>
</tr>
<tr>
<td>get_tasks_state2</td>
<td>获取状态为 2 的任务</td>
</tr>
<tr>
<td>set_task_state</td>
<td>设置指定任务的状态</td>
</tr>
<tr>
<td>set_task_state_running</td>
<td>设置指定任务状态为 1</td>
</tr>
<tr>
<td>set_task_state_done</td>
<td>设置指定任务状态为 2</td>
</tr>
<tr>
<td>set_task_state_failed</td>
<td>设置指定任务状态为 3</td>
</tr>
<tr>
<td>create_mysql_table</td>
<td>创建任务表、记录表</td>
</tr>
<tr>
<td>check_mysql_table_exists</td>
<td>检查表是否存在</td>
</tr>
<tr>
<td>insert_tasks</td>
<td>插入任务（字符串或字符串列表）</td>
</tr>
<tr>
<td>insert_task_record_start</td>
<td>创建记录表的初始记录</td>
</tr>
<tr>
<td>update_task_record</td>
<td>更新记录表任务处理量</td>
</tr>
<tr>
<td>update_task_record_end</td>
<td>更新当前爬虫结束</td>
</tr>
<tr>
<td>delete_task</td>
<td>删除任务</td>
</tr>
</tbody>
</table>
<h3 id="_6">创建</h3>
<pre><code>palp create -s baidu 3
</code></pre>
<h3 id="_7">设置</h3>
<p>注意：索引是顺序，应该将该中间件放在最后一个</p>
<pre><code># 启用则修改 task 表中对应任务的失败、生成状态
REQUEST_MIDDLEWARE = {
    1: &quot;palp.middleware.CycleSpiderRecordMiddleware&quot;,
}

# 启用则生成、汇总 record 表单批次爬取记录
SPIDER_MIDDLEWARE = {
    1: 'palp.middleware.CycleSpiderRecordMiddleware',
}
</code></pre>
<h3 id="_8">结构</h3>
<pre><code>import palp


class CycleSpider(palp.LocalSpider, palp.CycleSpider):
    spider_name = &quot;baidu&quot;  # 自定义的名字
    spider_domains = []  # 允许通过的域名，默认不限制
    spider_settings = None  # 字典形式或导入形式的设置
    spider_table_task_name = f'palp_cycle_task_{spider_name}'  # 任务表
    spider_table_record_name = f'palp_cycle_record_{spider_name}'  # 记录表

    def start_requests(self) -&gt; None:
        self.initialize_all_task_states()  # 重置所有任务状态为 0

        # 获取任务状态为 0 的任务
        for task in self.get_tasks_state0():
            print(task)
            yield palp.RequestGet(url=task['task'], task_id=task['id'])

    def parse(self, request, response) -&gt; None:
        print(response)


if __name__ == '__main__':
    CycleSpider.create_mysql_table()  # 快捷创建表
    CycleSpider.insert_tasks(['https://www.baidu.com', 'https://www.jd.com'])  # 快捷插入任务
    CycleSpider().start()
</code></pre>
<h3 id="task_id">task_id</h3>
<p>注意到这里传递了 task_id，那么什么时候传递 task_id？</p>
<ul>
<li>首先：task_id 代表 task 的 id，Request 中传递则代表当当前请求成功时 == 任务执行成功，框架自带更新状态</li>
<li>task 字段就是一个 url，请求成功视为执行成功</li>
<li>task 字段不是 url，那么就不需要 task_id 字段，只有在你觉得这个 task 执行结束时调用以下代码（比如 pipeline 收到指定数据）</li>
</ul>
<pre><code>spider.set_task_state_done(task_id=xxx)
spider.set_task_state_failed(task_id=xxx)
</code></pre>
<h3 id="cyclespiderrecordmiddleware">CycleSpiderRecordMiddleware</h3>
<p>该中间件会记录爬虫的执行状态</p>
<ul>
<li>spider_start： 启动时创建记录表初始记录（record 表）</li>
<li>request_failed： 传递 task_id 时，记录失败的请求（ task 表）</li>
<li>request_close： 传递 task_id 时，记录成功的请求（ task 表）</li>
<li>request_record： spider 结束时，更新 record 表，汇总结果</li>
</ul>
<p>当你想一直更新 record 表，那么可以自己去写实现，只需调用 CycleSpider 的方法即可</p>
<h2 id="jumpspider">JumpSpider</h2>
<p>这是用来解决频繁的登录、验证的，避免逻辑混乱<br />
该 spider 和其余 spider 没有关系，不走任何中间件，是完全独立的</p>
<p>该 spider 含有以下方法</p>
<ul>
<li>spider_start：执行开始时的方法</li>
<li>spider_close：执行结束时的方法</li>
<li>jump_out：自动合并 cookie、meta（可根据需求重写）</li>
</ul>
<p>注意：</p>
<ul>
<li>spider 运行错误时，将会将输入请求放入 redis 失败队列（分布式时，需开启对应设置）</li>
</ul>
<h3 id="_9">创建</h3>
<pre><code>palp create baidu 4
</code></pre>
<h3 id="_10">使用</h3>
<p>JumpSpider 内注意判断状态<br />
不正常的时候可以 yield 原始请求，达到循环的目的，直到达到我们的需求，再去执行正常代码</p>
<p>【示例】</p>
<pre><code>yield RequestGet(
    url='xx',
    jump_spider='xxx',  # 导入 JumpSpider（不需要实例化）
    jump_spider_kwargs={},  # 导入的参数 JumpSpider 中 self.xxx 访问
    jump_request_middleware='xxx',   # 导入请求中间件（不需要实例化）
    callback='xxx'
)
</code></pre>
<h2 id="_11">启动爬虫</h2>
<h3 id="_12">爬虫内启动</h3>
<pre><code>BaiduSpider(thread_count=1).start() # 启动可选参数看源码
</code></pre>
<h3 id="_13">启动文件启动</h3>
<p>注意：是进程形式启动，推荐直接使用 start.py 即可，可同时启动多个爬虫</p>
<p>参数介绍</p>
<ul>
<li>spider_name：爬虫名（spider 内一致）</li>
<li>count：启动多少个实例（可实现单机分布式，就是进程启动多少个）</li>
<li>**kwargs：爬虫启动参数，同 spider 的启动参数</li>
</ul>
<p>【示例】</p>
<pre><code>from palp import start_spider


def main():
    start_spider.execute(spider_name='xxx', count=1)


if __name__ == '__main__':
    main()
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../command/" class="btn btn-neutral float-left" title="Command"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../database/" class="btn btn-neutral float-right" title="Database">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../command/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../database/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
