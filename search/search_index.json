{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Index \u7b80\u4ecb Palp \u662f\u4e00\u4e2a\u722c\u866b\u6846\u67b6 \u6574\u4f53\u4f7f\u7528\u65b9\u5f0f\u548c scrapy \u7c7b\u4f3c\uff0c\u4f46\u6709\u4ee5\u4e0b\u7279\u70b9 \u540c\u4e00\u4e2a\u9879\u76ee\u53ef\u4ee5\u5b58\u653e\u591a\u4e2a\u4e0d\u540c\u7684 spider\uff0cspider \u53ef\u4ee5\u62e5\u6709\u5404\u81ea\u7684 settings \u65e0\u611f\u5206\u5e03\u5f0f\uff0c\u968f\u65f6\u6dfb\u52a0 slave\uff0c\u4e0d\u9700\u8981\u5185\u7f51\uff0c\u53ea\u9700\u8981 redis\uff0c\u5206\u5e03\u5f0f\u4e0e\u975e\u5206\u5e03\u5f0f\u4ec5\u7ee7\u627f\u7684\u7c7b\u4e0d\u540c master \u4ec5\u5206\u53d1\u4efb\u52a1\uff0c\u65e0\u771f\u6b63\u7684 master\uff0c\u6b7b\u673a\u81ea\u52a8\u5207\u6362 \u81ea\u52a8 cookiejar \u4ec5\u9700\u8981\u4f7f\u7528 keep_cookie \u5373\u53ef \u81ea\u5e26 requests\uff08\u9ed8\u8ba4\uff09\u3001httpx \u4e24\u79cd\u8bf7\u6c42\u5668\uff0c\u5e76\u53ef\u81ea\u5b9a\u4e49\u8bf7\u6c42\u5668\uff08\u540c\u65f6\u9700\u8981\u81ea\u5b9a\u4e49\u89e3\u6790\u5668\uff09 \u81ea\u52a8 join response url \u6570\u636e\u3001\u4efb\u52a1\u5931\u8d25\u540e\u81ea\u52a8\u56de\u6536\uff0c\u542f\u52a8\u81ea\u52a8\u63a5\u7eed\uff08\u9700\u5f00\u542f\u5bf9\u5e94\u8bbe\u7f6e\uff09 \u6210\u529f\u3001\u5931\u8d25\u4efb\u52a1\u81ea\u52a8\u7edf\u8ba1\u5230 request_record \u5206\u5e03\u5f0f\u65f6\uff0c\u5927\u91cf\u4efb\u52a1\u7684 cookie\u3001\u53c2\u6570 \u590d\u7528 \u5185\u542b JumpSpider\uff08\u8f85\u52a9\u578b\uff09 \u7528\u4e8e\u6267\u884c\u9891\u7e41\u7684\u9a8c\u8bc1\u3001\u767b\u5f55\u64cd\u4f5c\u7b49\uff0c\u7b80\u5316\u4ee3\u7801\u903b\u8f91 \u5185\u542b Checker\uff0c\u53ef\u4ee5\u7528\u6765\u5224\u65ad\u7f51\u7ad9\u72b6\u6001\uff0c\u5e76\u9009\u62e9\u963b\u62e6\u65b0\u8bf7\u6c42\u76f4\u5230\u6062\u590d\u6216\u505c\u6b62 spider \u6267\u884c \u4f46\u6709\u4ee5\u4e0b\u6ce8\u610f\u70b9\uff1a \u9ed8\u8ba4\u4e0d\u53bb\u91cd\uff0c\u4f46\u662f\u9ed8\u8ba4\u662f\u4f18\u5148\u7ea7\u961f\u5217\uff0c\u5206\u5e03\u5f0f\u65f6\u7684 redis zset \u5177\u5907\u4e00\u5b9a\u7684\u53bb\u91cd\u6548\u679c \u5f00\u542f\u53bb\u91cd\u65f6\uff0c\u53bb\u91cd\u4e00\u822c\u4e3a\u666e\u901a\u53bb\u91cd\uff08\u9ed8\u8ba4\uff09\uff0c\u4e5f\u6709\u4e25\u683c\u53bb\u91cd\uff08\u9700\u5f00\u542f\uff09\uff0c\u4e25\u683c\u53bb\u91cd\u65f6\uff0c\u4f1a\u6709\u9501\u3001\u5206\u5e03\u5f0f\u9501 \u5b89\u88c5 pip install palp","title":"Home"},{"location":"#index","text":"","title":"Index"},{"location":"#_1","text":"Palp \u662f\u4e00\u4e2a\u722c\u866b\u6846\u67b6 \u6574\u4f53\u4f7f\u7528\u65b9\u5f0f\u548c scrapy \u7c7b\u4f3c\uff0c\u4f46\u6709\u4ee5\u4e0b\u7279\u70b9 \u540c\u4e00\u4e2a\u9879\u76ee\u53ef\u4ee5\u5b58\u653e\u591a\u4e2a\u4e0d\u540c\u7684 spider\uff0cspider \u53ef\u4ee5\u62e5\u6709\u5404\u81ea\u7684 settings \u65e0\u611f\u5206\u5e03\u5f0f\uff0c\u968f\u65f6\u6dfb\u52a0 slave\uff0c\u4e0d\u9700\u8981\u5185\u7f51\uff0c\u53ea\u9700\u8981 redis\uff0c\u5206\u5e03\u5f0f\u4e0e\u975e\u5206\u5e03\u5f0f\u4ec5\u7ee7\u627f\u7684\u7c7b\u4e0d\u540c master \u4ec5\u5206\u53d1\u4efb\u52a1\uff0c\u65e0\u771f\u6b63\u7684 master\uff0c\u6b7b\u673a\u81ea\u52a8\u5207\u6362 \u81ea\u52a8 cookiejar \u4ec5\u9700\u8981\u4f7f\u7528 keep_cookie \u5373\u53ef \u81ea\u5e26 requests\uff08\u9ed8\u8ba4\uff09\u3001httpx \u4e24\u79cd\u8bf7\u6c42\u5668\uff0c\u5e76\u53ef\u81ea\u5b9a\u4e49\u8bf7\u6c42\u5668\uff08\u540c\u65f6\u9700\u8981\u81ea\u5b9a\u4e49\u89e3\u6790\u5668\uff09 \u81ea\u52a8 join response url \u6570\u636e\u3001\u4efb\u52a1\u5931\u8d25\u540e\u81ea\u52a8\u56de\u6536\uff0c\u542f\u52a8\u81ea\u52a8\u63a5\u7eed\uff08\u9700\u5f00\u542f\u5bf9\u5e94\u8bbe\u7f6e\uff09 \u6210\u529f\u3001\u5931\u8d25\u4efb\u52a1\u81ea\u52a8\u7edf\u8ba1\u5230 request_record \u5206\u5e03\u5f0f\u65f6\uff0c\u5927\u91cf\u4efb\u52a1\u7684 cookie\u3001\u53c2\u6570 \u590d\u7528 \u5185\u542b JumpSpider\uff08\u8f85\u52a9\u578b\uff09 \u7528\u4e8e\u6267\u884c\u9891\u7e41\u7684\u9a8c\u8bc1\u3001\u767b\u5f55\u64cd\u4f5c\u7b49\uff0c\u7b80\u5316\u4ee3\u7801\u903b\u8f91 \u5185\u542b Checker\uff0c\u53ef\u4ee5\u7528\u6765\u5224\u65ad\u7f51\u7ad9\u72b6\u6001\uff0c\u5e76\u9009\u62e9\u963b\u62e6\u65b0\u8bf7\u6c42\u76f4\u5230\u6062\u590d\u6216\u505c\u6b62 spider \u6267\u884c \u4f46\u6709\u4ee5\u4e0b\u6ce8\u610f\u70b9\uff1a \u9ed8\u8ba4\u4e0d\u53bb\u91cd\uff0c\u4f46\u662f\u9ed8\u8ba4\u662f\u4f18\u5148\u7ea7\u961f\u5217\uff0c\u5206\u5e03\u5f0f\u65f6\u7684 redis zset \u5177\u5907\u4e00\u5b9a\u7684\u53bb\u91cd\u6548\u679c \u5f00\u542f\u53bb\u91cd\u65f6\uff0c\u53bb\u91cd\u4e00\u822c\u4e3a\u666e\u901a\u53bb\u91cd\uff08\u9ed8\u8ba4\uff09\uff0c\u4e5f\u6709\u4e25\u683c\u53bb\u91cd\uff08\u9700\u5f00\u542f\uff09\uff0c\u4e25\u683c\u53bb\u91cd\u65f6\uff0c\u4f1a\u6709\u9501\u3001\u5206\u5e03\u5f0f\u9501","title":"\u7b80\u4ecb"},{"location":"#_2","text":"pip install palp","title":"\u5b89\u88c5"},{"location":"command/","text":"Command \u547d\u4ee4\u884c\u5de5\u5177 cmd \u4e2d\u8f93\u5165 palp \u5373\u53ef\u770b\u5230\u5e2e\u52a9\u4fe1\u606f palp \u7248\u672c\u53f7 Palp \u64cd\u4f5c\u547d\u4ee4\u5982\u4e0b palp create [options] [args] \u53ef\u9009 options: -p \u5373 project\uff0c\u521b\u5efa\u722c\u866b\u9879\u76ee -s \u5373 spider\uff0c\u521b\u5efa\u722c\u866b \u53ef\u9009 args: 1 \u521b\u5efa spider \u65f6\uff0c\u521b\u5efa\u666e\u901a spider 2 \u521b\u5efa spider \u65f6\uff0c\u521b\u5efa\u5206\u5e03\u5f0f spider 3 \u521b\u5efa spider \u65f6\uff0c\u521b\u5efa\u5468\u671f spider \u793a\u4f8b: palp create -p demo palp create -s baidu 1 \u521b\u5efa\u9879\u76ee \u521b\u5efa\u9879\u76ee\u548c\u722c\u866b\u90fd\u4f1a\u53bb\u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728 palp create -p xxx \u521b\u5efa\u722c\u866b \u521b\u5efa\u722c\u866b\u65f6\uff0c\u4f1a\u81ea\u52a8\u79fb\u52a8\u5230 spiders \u6587\u4ef6\u5939\u4e0b\uff08\u67e5\u627e\u4e3a 3 \u4e2a\u6df1\u5ea6\uff09 palp create -s xxx 1","title":"Command"},{"location":"command/#command","text":"","title":"Command"},{"location":"command/#_1","text":"cmd \u4e2d\u8f93\u5165 palp \u5373\u53ef\u770b\u5230\u5e2e\u52a9\u4fe1\u606f palp \u7248\u672c\u53f7 Palp \u64cd\u4f5c\u547d\u4ee4\u5982\u4e0b palp create [options] [args] \u53ef\u9009 options: -p \u5373 project\uff0c\u521b\u5efa\u722c\u866b\u9879\u76ee -s \u5373 spider\uff0c\u521b\u5efa\u722c\u866b \u53ef\u9009 args: 1 \u521b\u5efa spider \u65f6\uff0c\u521b\u5efa\u666e\u901a spider 2 \u521b\u5efa spider \u65f6\uff0c\u521b\u5efa\u5206\u5e03\u5f0f spider 3 \u521b\u5efa spider \u65f6\uff0c\u521b\u5efa\u5468\u671f spider \u793a\u4f8b: palp create -p demo palp create -s baidu 1","title":"\u547d\u4ee4\u884c\u5de5\u5177"},{"location":"command/#_2","text":"\u521b\u5efa\u9879\u76ee\u548c\u722c\u866b\u90fd\u4f1a\u53bb\u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728 palp create -p xxx","title":"\u521b\u5efa\u9879\u76ee"},{"location":"command/#_3","text":"\u521b\u5efa\u722c\u866b\u65f6\uff0c\u4f1a\u81ea\u52a8\u79fb\u52a8\u5230 spiders \u6587\u4ef6\u5939\u4e0b\uff08\u67e5\u627e\u4e3a 3 \u4e2a\u6df1\u5ea6\uff09 palp create -s xxx 1","title":"\u521b\u5efa\u722c\u866b"},{"location":"database/","text":"Database \u6570\u636e\u5e93\u8fde\u63a5 \u5185\u7f6e quickdb \u6a21\u5757\uff0c\u542b\u6709 redis\u3001mongo\u3001mysql\u3001kafka\u3001postgresql \u7684\u8fde\u63a5\uff0c\u5f15\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a from palp import conn conn.redis_conn # \u63a5\u539f\u59cb\u547d\u4ee4 conn.pg_conn # \u57fa\u4e8e sqlalchemy \u9b54\u6539\u7248\u672c conn.mysql_conn # \u57fa\u4e8e sqlalchemy \u9b54\u6539\u7248\u672c conn.mongo_conn # \u57fa\u4e8e mongo_conn \u6dfb\u52a0\u4e86\u90e8\u5206\u65b9\u6cd5\uff0c\u5982 iter conn.kafka_conn # kafka_conn.send \u5373\u53ef \u6ce8\u610f\uff1a\u5185\u7f6e\u4e86 SpiderRecycleMiddleware \u4e2d\u95f4\u4ef6\uff0c\u521b\u5efa\u7684\u8fde\u63a5\u4f1a\u81ea\u52a8\u5173\u95ed \u5177\u4f53\u7684\u4f7f\u7528\u53ef\u4ee5\u770b quickdb \u6a21\u5757\uff0c\u8fd9\u91cc\u5f3a\u70c8\u63a8\u8350 quickdb \u9488\u5bf9 sqlalchemy \u7684\u6570\u636e\u5e93\u6a21\u677f\u5bfc\u51fa\u529f\u80fd\uff1a from quickdb import PostgreSQLAlchemyEngine pg_conn = PostgreSQLAlchemyEngine( host=settings.PG_HOST, port=settings.PG_PORT, db=settings.PG_DB, user=settings.PG_USER, pwd=settings.PG_PWD, **settings.PG_CONFIG ) pg_conn.reverse_table_model(path='./models.py', tables=['xxx']) # path \u53ef\u4ee5\u81ea\u52a8\u751f\u6210 redis \u914d\u7f6e REDIS_DB = 0 REDIS_HOST = '127.0.0.1' REDIS_PORT = '6379' REDIS_PWD = None \u4f7f\u7528 from palp.conn import redis_conn redis_conn.info() postgresql \u57fa\u4e8e sqlalchemy \u8fdb\u884c\u4fee\u6539\uff0c\u542b\u6709\u5f88\u591a\u65b9\u6cd5 \u914d\u7f6e PG_HOST = None PG_PORT = None PG_DB = None PG_USER = None PG_PWD = None \u4f7f\u7528 from palp.conn import pg_conn pg_conn.execute() mysql \u57fa\u4e8e sqlalchemy \u8fdb\u884c\u4fee\u6539\uff0c\u542b\u6709\u5f88\u591a\u65b9\u6cd5 \u914d\u7f6e MYSQL_HOST = '127.0.0.1' MYSQL_PORT = 3306 MYSQL_DB = None MYSQL_USER = None MYSQL_PWD = None \u4f7f\u7528 from palp.conn import mysql_conn mysql_conn.execute() mongo \u57fa\u4e8e pymongo \u8fdb\u884c\u4fee\u6539\uff0c\u90e8\u5206\u65b0\u589e\u65b9\u6cd5\u5982\u4e0b\uff1a iter\uff1a\u8fed\u4ee3\u6570\u636e\u5e93\u6240\u6709\u6570\u636e upsert\uff1a\u63d2\u5165\u6216\u66f4\u65b0 \u914d\u7f6e MONGO_HOST = None MONGO_PORT = None MONGO_USER = None MONGO_PWD = None \u4f7f\u7528 from palp.conn import mongo_conn col = mongo_conn.get_collection(db='x', col='xx') for data in col.iter(): print(data) kafka \u57fa\u4e8e kafka-python \u4fee\u6539 \u914d\u7f6e KAFKA_SERVER = None \u4f7f\u7528 from palp.conn import kafka_conn kafka_conn.send()","title":"Database"},{"location":"database/#database","text":"","title":"Database"},{"location":"database/#_1","text":"\u5185\u7f6e quickdb \u6a21\u5757\uff0c\u542b\u6709 redis\u3001mongo\u3001mysql\u3001kafka\u3001postgresql \u7684\u8fde\u63a5\uff0c\u5f15\u7528\u65b9\u5f0f\u5982\u4e0b\uff1a from palp import conn conn.redis_conn # \u63a5\u539f\u59cb\u547d\u4ee4 conn.pg_conn # \u57fa\u4e8e sqlalchemy \u9b54\u6539\u7248\u672c conn.mysql_conn # \u57fa\u4e8e sqlalchemy \u9b54\u6539\u7248\u672c conn.mongo_conn # \u57fa\u4e8e mongo_conn \u6dfb\u52a0\u4e86\u90e8\u5206\u65b9\u6cd5\uff0c\u5982 iter conn.kafka_conn # kafka_conn.send \u5373\u53ef \u6ce8\u610f\uff1a\u5185\u7f6e\u4e86 SpiderRecycleMiddleware \u4e2d\u95f4\u4ef6\uff0c\u521b\u5efa\u7684\u8fde\u63a5\u4f1a\u81ea\u52a8\u5173\u95ed \u5177\u4f53\u7684\u4f7f\u7528\u53ef\u4ee5\u770b quickdb \u6a21\u5757\uff0c\u8fd9\u91cc\u5f3a\u70c8\u63a8\u8350 quickdb \u9488\u5bf9 sqlalchemy \u7684\u6570\u636e\u5e93\u6a21\u677f\u5bfc\u51fa\u529f\u80fd\uff1a from quickdb import PostgreSQLAlchemyEngine pg_conn = PostgreSQLAlchemyEngine( host=settings.PG_HOST, port=settings.PG_PORT, db=settings.PG_DB, user=settings.PG_USER, pwd=settings.PG_PWD, **settings.PG_CONFIG ) pg_conn.reverse_table_model(path='./models.py', tables=['xxx']) # path \u53ef\u4ee5\u81ea\u52a8\u751f\u6210","title":"\u6570\u636e\u5e93\u8fde\u63a5"},{"location":"database/#redis","text":"","title":"redis"},{"location":"database/#_2","text":"REDIS_DB = 0 REDIS_HOST = '127.0.0.1' REDIS_PORT = '6379' REDIS_PWD = None","title":"\u914d\u7f6e"},{"location":"database/#_3","text":"from palp.conn import redis_conn redis_conn.info()","title":"\u4f7f\u7528"},{"location":"database/#postgresql","text":"\u57fa\u4e8e sqlalchemy \u8fdb\u884c\u4fee\u6539\uff0c\u542b\u6709\u5f88\u591a\u65b9\u6cd5","title":"postgresql"},{"location":"database/#_4","text":"PG_HOST = None PG_PORT = None PG_DB = None PG_USER = None PG_PWD = None","title":"\u914d\u7f6e"},{"location":"database/#_5","text":"from palp.conn import pg_conn pg_conn.execute()","title":"\u4f7f\u7528"},{"location":"database/#mysql","text":"\u57fa\u4e8e sqlalchemy \u8fdb\u884c\u4fee\u6539\uff0c\u542b\u6709\u5f88\u591a\u65b9\u6cd5","title":"mysql"},{"location":"database/#_6","text":"MYSQL_HOST = '127.0.0.1' MYSQL_PORT = 3306 MYSQL_DB = None MYSQL_USER = None MYSQL_PWD = None","title":"\u914d\u7f6e"},{"location":"database/#_7","text":"from palp.conn import mysql_conn mysql_conn.execute()","title":"\u4f7f\u7528"},{"location":"database/#mongo","text":"\u57fa\u4e8e pymongo \u8fdb\u884c\u4fee\u6539\uff0c\u90e8\u5206\u65b0\u589e\u65b9\u6cd5\u5982\u4e0b\uff1a iter\uff1a\u8fed\u4ee3\u6570\u636e\u5e93\u6240\u6709\u6570\u636e upsert\uff1a\u63d2\u5165\u6216\u66f4\u65b0","title":"mongo"},{"location":"database/#_8","text":"MONGO_HOST = None MONGO_PORT = None MONGO_USER = None MONGO_PWD = None","title":"\u914d\u7f6e"},{"location":"database/#_9","text":"from palp.conn import mongo_conn col = mongo_conn.get_collection(db='x', col='xx') for data in col.iter(): print(data)","title":"\u4f7f\u7528"},{"location":"database/#kafka","text":"\u57fa\u4e8e kafka-python \u4fee\u6539","title":"kafka"},{"location":"database/#_10","text":"KAFKA_SERVER = None","title":"\u914d\u7f6e"},{"location":"database/#_11","text":"from palp.conn import kafka_conn kafka_conn.send()","title":"\u4f7f\u7528"},{"location":"item/","text":"Item \u901a\u8fc7 yield item \u5c06\u6570\u636e\u53d1\u9001\u5230 pipeline \u8fdb\u884c\u4fdd\u5b58 Item \u63d0\u4f9b\u4e86\u4e24\u79cd LazyItem StrictItem LazyItem \u5373\uff1a\u61d2\u4eba item\uff0c\u4e0d\u9700\u8981\u5b9a\u4e49\u5b57\u6bb5\uff0c\u4f46\u662f\u6700\u597d\u6709\u591a\u4e2a\u5c31\u5199\u4e0d\u540c\u7684\u540d\u5b57\u505a\u533a\u5206 \u3010\u521b\u5efa\u3011 import palp class LazyItem(palp.LazyItem): \"\"\" \u901a\u7528\u3001\u61d2\u4eba item \"\"\" \u3010\u4f7f\u7528\u3011 yield LazyItem(**{'xxx':'yyy'}) StrictItem \u4e25\u683c item\uff0c\u9700\u8981\u5b9a\u4e49\u54ea\u4e9b\u5b57\u6bb5\u88ab\u5141\u8bb8\u901a\u8fc7\uff0c\u975e\u5b9a\u4e49\u5b57\u6bb5\u5c06\u629b\u51fa NotStrictItemFieldException \u9519\u8bef import palp class StrictItem(palp.StrictItem): \"\"\" \u4e25\u683c item \"\"\" # \u6b64\u5904\u9700\u8981\u5b9a\u4e49\u6570\u636e\u5e93\u5b57\u6bb5 # name = palp.Field() \u3010\u4f7f\u7528\u3011 yield StrictItem(**{'xxx':'yyy'})","title":"Item"},{"location":"item/#item","text":"\u901a\u8fc7 yield item \u5c06\u6570\u636e\u53d1\u9001\u5230 pipeline \u8fdb\u884c\u4fdd\u5b58 Item \u63d0\u4f9b\u4e86\u4e24\u79cd LazyItem StrictItem","title":"Item"},{"location":"item/#lazyitem","text":"\u5373\uff1a\u61d2\u4eba item\uff0c\u4e0d\u9700\u8981\u5b9a\u4e49\u5b57\u6bb5\uff0c\u4f46\u662f\u6700\u597d\u6709\u591a\u4e2a\u5c31\u5199\u4e0d\u540c\u7684\u540d\u5b57\u505a\u533a\u5206 \u3010\u521b\u5efa\u3011 import palp class LazyItem(palp.LazyItem): \"\"\" \u901a\u7528\u3001\u61d2\u4eba item \"\"\" \u3010\u4f7f\u7528\u3011 yield LazyItem(**{'xxx':'yyy'})","title":"LazyItem"},{"location":"item/#strictitem","text":"\u4e25\u683c item\uff0c\u9700\u8981\u5b9a\u4e49\u54ea\u4e9b\u5b57\u6bb5\u88ab\u5141\u8bb8\u901a\u8fc7\uff0c\u975e\u5b9a\u4e49\u5b57\u6bb5\u5c06\u629b\u51fa NotStrictItemFieldException \u9519\u8bef import palp class StrictItem(palp.StrictItem): \"\"\" \u4e25\u683c item \"\"\" # \u6b64\u5904\u9700\u8981\u5b9a\u4e49\u6570\u636e\u5e93\u5b57\u6bb5 # name = palp.Field() \u3010\u4f7f\u7528\u3011 yield StrictItem(**{'xxx':'yyy'})","title":"StrictItem"},{"location":"middleware/","text":"Middleware SpiderMiddleware \u8fd9\u662f\u9879\u76ee\u4e2d\u95f4\u4ef6\uff08\u53ef\u901a\u8fc7 spider \u8bbf\u95ee\u5230\u5bf9\u5e94\u7684\u5c5e\u6027\uff09 spider_start\uff1a\u722c\u866b\u542f\u52a8\u65f6\u5e72\u4ec0\u4e48 spider_error\uff1a\u722c\u866b\u51fa\u9519\u65f6\u5e72\u4ec0\u4e48 spider_close\uff1a\u722c\u866b\u7ed3\u675f\u65f6\u5e72\u4ec0\u4e48\uff08\u5fc5\u5b9a\u4f1a\u6267\u884c\uff09 \u7ed3\u6784 import palp from loguru import logger class SpiderMiddleware(palp.SpiderMiddleware): def spider_start(self, spider) -> None: \"\"\" spider \u5f00\u59cb\u65f6\u7684\u64cd\u4f5c :param spider: :return: \"\"\" def spider_error(self, spider, exception: Exception) -> None: \"\"\" spider \u51fa\u9519\u65f6\u7684\u64cd\u4f5c :param spider: :param exception: \u9519\u8bef\u7684\u8be6\u7ec6\u4fe1\u606f :return: \"\"\" logger.error(exception) def spider_close(self, spider) -> None: \"\"\" spider \u7ed3\u675f\u7684\u64cd\u4f5c :param spider: :return: \"\"\" \u8bbe\u7f6e \u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 1 \u4ee3\u8868\u987a\u5e8f SPIDER_MIDDLEWARE = { 1: 'middlewares.middleware.SpiderMiddleware', } RequestMiddleware \u8fd9\u662f\u8bf7\u6c42\u4e2d\u95f4\u4ef6\uff08\u53ef\u901a\u8fc7 spider \u8bbf\u95ee\u5230\u5bf9\u5e94\u7684\u5c5e\u6027\uff09 request_in\uff1a\u8bf7\u6c42\u521b\u5efa\u65f6\u5e72\u4ec0\u4e48 request_error\uff1a\u8bf7\u6c42\u51fa\u9519\u65f6\u5e72\u4ec0\u4e48\uff08\u9ed8\u8ba4\u91cd\u8bd5 3 \u6b21 settings.REQUEST_RETRY_TIMES\uff09 request_failed\uff1a\u8bf7\u6c42\u5931\u8d25\u65f6\u5e72\u4ec0\u4e48\uff083 \u6b21\u540e\u8fd8\u5931\u8d25\uff0c\u8d70\u8fd9\u91cc\uff09 request_close\uff1a\u8bf7\u6c42\u7ed3\u675f\u65f6\u5e72\u4ec0\u4e48\uff08\u6267\u884c\u5b8c\u6bd5\u540e\u8d70\u8fd9\u91cc\uff09 request_record\uff1a\u8bf7\u6c42\u7ed3\u675f\u7684\u7ed3\u679c\u8bb0\u5f55\uff08\u6267\u884c\u5b8c\u6bd5\u540e\u8d70\u8fd9\u91cc\uff0cJumpSpider \u4e0d\u8d70\u8be5\u51fd\u6570\uff09 \u6ce8\u610f\uff1a request_failed \u548c request_close \u53ea\u6709\u8d70\u5176\u4e2d\u4e00\u4e2a \u4e0d\u8981\u7684\u8bf7\u6c42\u53ef\u76f4\u63a5\u629b\u51fa DropRequestException \u9519\u8bef \u8bf7\u6c42\u53ef\u4ee5\u539f\u5730\u4fee\u6539 request_error \u53ef\u4ee5\u5224\u65ad\u9519\u8bef\u8fdb\u884c\u4fee\u6539\uff0c\u6216\u8005\u76f4\u63a5 return \u65b0\u7684\u8bf7\u6c42\uff0c\u65e7\u8bf7\u6c42\u81ea\u52a8\u4e22\u5f03 request_close \u53ef\u4ee5\u5224\u65ad\u54cd\u5e94\u662f\u5426\u7b26\u5408\u9884\u671f\uff0c\u6216\u8005\u76f4\u63a5 return \u65b0\u7684\u8bf7\u6c42\uff0c\u65e7\u8bf7\u6c42\u81ea\u52a8\u4e22\u5f03 \u63d0\u793a\uff1a \u5206\u5e03\u5f0f\u722c\u866b\u65f6\uff0c\u8bbe\u7f6e\u5f00\u542f\u4ee5\u4e0b\u4e24\u4e2a\u9009\u9879\uff0c\u5373\u53ef\u81ea\u52a8\u4fdd\u5b58\u9519\u8bef\u8bf7\u6c42\uff0c\u5e76\u5b58\u653e redis\uff0c\u4e0b\u6b21\u8bf7\u6c42\u81ea\u52a8\u7ee7\u7eed REQUEST_FAILED_SAVE = True # \u5206\u5e03\u5f0f\u65f6\u4fdd\u5b58\u5931\u8d25\u7684\u8bf7\u6c42\uff08\u91cd\u8bd5\u4e4b\u540e\u4ecd\u7136\u5931\u8d25\u7684\uff09 REQUEST_RETRY_FAILED = True # \u5206\u5e03\u5f0f\u65f6\u542f\u52a8\u91cd\u8bd5\u5931\u8d25\u8bf7\u6c42 \u7ed3\u6784 import palp from typing import Union from palp import settings from loguru import logger from palp.network.request import Request class RequestMiddleware(palp.RequestMiddleware): def request_in(self, spider, request) -> None: \"\"\" \u8bf7\u6c42\u8fdb\u5165\u65f6\u7684\u64cd\u4f5c :param spider: :param request: :return: \"\"\" if settings.REQUEST_PROXIES_TUNNEL_URL: request.proxies = { 'http': settings.REQUEST_PROXIES_TUNNEL_URL, 'https': settings.REQUEST_PROXIES_TUNNEL_URL, } def request_error(self, spider, request, exception: Exception) -> Union[Request, None]: \"\"\" \u8bf7\u6c42\u51fa\u9519\u65f6\u7684\u64cd\u4f5c :param spider: :param request: \u8be5\u53c2\u6570\u53ef\u8fd4\u56de\uff08\u7528\u4e8e\u653e\u5f03\u5f53\u524d\u8bf7\u6c42\uff0c\u5e76\u53d1\u8d77\u65b0\u8bf7\u6c42\uff09 :param exception: \u9519\u8bef\u7684\u8be6\u7ec6\u4fe1\u606f :return: [Request, None] \"\"\" logger.error(exception) return def request_failed(self, spider, request) -> None: \"\"\" \u8d85\u8fc7\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u65f6\u7684\u64cd\u4f5c :param spider: :param request: :return: \"\"\" logger.warning(f\"\u5931\u8d25\u7684\u8bf7\u6c42\uff1a{request}\") def request_close(self, spider, request, response) -> Union[Request, None]: \"\"\" \u8bf7\u6c42\u7ed3\u675f\u65f6\u7684\u64cd\u4f5c :param spider: :param request: \u8be5\u53c2\u6570\u53ef\u8fd4\u56de\uff08\u7528\u4e8e\u653e\u5f03\u5f53\u524d\u8bf7\u6c42\uff0c\u5e76\u53d1\u8d77\u65b0\u8bf7\u6c42\uff09 :param response: :return: [Request, None] \"\"\" return def request_record(self, spider, record: dict) -> None: \"\"\" \u8bf7\u6c42\u7ed3\u679c\u8bb0\u5f55\uff08\u5728 spider \u7ed3\u675f\u65f6\u8c03\u7528\uff09 :param spider: :param record: :return: \"\"\" logger.info(\"{} \u6267\u884c\u5b8c\u6bd5\uff0c\u8bf7\u6c42\u91cf\u7edf\u8ba1\uff1a{}\", spider.spider_name, record) \u8bbe\u7f6e \u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 1 \u4ee3\u8868\u987a\u5e8f REQUEST_MIDDLEWARE = { 1: \"middlewares.middleware.RequestMiddleware\", } \u6dfb\u52a0\u4ee3\u7406 \u6ce8\u610f\uff1a\u8fd9\u91cc\u57fa\u4e8e\u9ed8\u8ba4\u7684 ResponseDownloaderByRequests \u8bf7\u6c42\u5668\uff08requests\uff09 class RequestMiddleware(palp.RequestMiddleware): def request_in(self, spider, request) -> None: \"\"\" \u8bf7\u6c42\u8fdb\u5165\u65f6\u7684\u64cd\u4f5c :param spider: :param request: :return: \"\"\" # \u7ed9\u6240\u6709 url \u90fd\u6dfb\u52a0\u4ee3\u7406 if settings.REQUEST_PROXIES_TUNNEL_URL and not request.proxies: request.proxies = { 'http': settings.REQUEST_PROXIES_TUNNEL_URL, 'https': settings.REQUEST_PROXIES_TUNNEL_URL, } # \u6307\u5b9a\u57df\u540d\u6dfb\u52a0\u4ee3\u7406 allow_domains = ['xxx'] if settings.REQUEST_PROXIES_TUNNEL_URL and not request.proxies: if request.domain in allow_domains: request.proxies = { 'http': settings.REQUEST_PROXIES_TUNNEL_URL, 'https': settings.REQUEST_PROXIES_TUNNEL_URL, }","title":"Middleware"},{"location":"middleware/#middleware","text":"","title":"Middleware"},{"location":"middleware/#spidermiddleware","text":"\u8fd9\u662f\u9879\u76ee\u4e2d\u95f4\u4ef6\uff08\u53ef\u901a\u8fc7 spider \u8bbf\u95ee\u5230\u5bf9\u5e94\u7684\u5c5e\u6027\uff09 spider_start\uff1a\u722c\u866b\u542f\u52a8\u65f6\u5e72\u4ec0\u4e48 spider_error\uff1a\u722c\u866b\u51fa\u9519\u65f6\u5e72\u4ec0\u4e48 spider_close\uff1a\u722c\u866b\u7ed3\u675f\u65f6\u5e72\u4ec0\u4e48\uff08\u5fc5\u5b9a\u4f1a\u6267\u884c\uff09","title":"SpiderMiddleware"},{"location":"middleware/#_1","text":"import palp from loguru import logger class SpiderMiddleware(palp.SpiderMiddleware): def spider_start(self, spider) -> None: \"\"\" spider \u5f00\u59cb\u65f6\u7684\u64cd\u4f5c :param spider: :return: \"\"\" def spider_error(self, spider, exception: Exception) -> None: \"\"\" spider \u51fa\u9519\u65f6\u7684\u64cd\u4f5c :param spider: :param exception: \u9519\u8bef\u7684\u8be6\u7ec6\u4fe1\u606f :return: \"\"\" logger.error(exception) def spider_close(self, spider) -> None: \"\"\" spider \u7ed3\u675f\u7684\u64cd\u4f5c :param spider: :return: \"\"\"","title":"\u7ed3\u6784"},{"location":"middleware/#_2","text":"\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 1 \u4ee3\u8868\u987a\u5e8f SPIDER_MIDDLEWARE = { 1: 'middlewares.middleware.SpiderMiddleware', }","title":"\u8bbe\u7f6e"},{"location":"middleware/#requestmiddleware","text":"\u8fd9\u662f\u8bf7\u6c42\u4e2d\u95f4\u4ef6\uff08\u53ef\u901a\u8fc7 spider \u8bbf\u95ee\u5230\u5bf9\u5e94\u7684\u5c5e\u6027\uff09 request_in\uff1a\u8bf7\u6c42\u521b\u5efa\u65f6\u5e72\u4ec0\u4e48 request_error\uff1a\u8bf7\u6c42\u51fa\u9519\u65f6\u5e72\u4ec0\u4e48\uff08\u9ed8\u8ba4\u91cd\u8bd5 3 \u6b21 settings.REQUEST_RETRY_TIMES\uff09 request_failed\uff1a\u8bf7\u6c42\u5931\u8d25\u65f6\u5e72\u4ec0\u4e48\uff083 \u6b21\u540e\u8fd8\u5931\u8d25\uff0c\u8d70\u8fd9\u91cc\uff09 request_close\uff1a\u8bf7\u6c42\u7ed3\u675f\u65f6\u5e72\u4ec0\u4e48\uff08\u6267\u884c\u5b8c\u6bd5\u540e\u8d70\u8fd9\u91cc\uff09 request_record\uff1a\u8bf7\u6c42\u7ed3\u675f\u7684\u7ed3\u679c\u8bb0\u5f55\uff08\u6267\u884c\u5b8c\u6bd5\u540e\u8d70\u8fd9\u91cc\uff0cJumpSpider \u4e0d\u8d70\u8be5\u51fd\u6570\uff09 \u6ce8\u610f\uff1a request_failed \u548c request_close \u53ea\u6709\u8d70\u5176\u4e2d\u4e00\u4e2a \u4e0d\u8981\u7684\u8bf7\u6c42\u53ef\u76f4\u63a5\u629b\u51fa DropRequestException \u9519\u8bef \u8bf7\u6c42\u53ef\u4ee5\u539f\u5730\u4fee\u6539 request_error \u53ef\u4ee5\u5224\u65ad\u9519\u8bef\u8fdb\u884c\u4fee\u6539\uff0c\u6216\u8005\u76f4\u63a5 return \u65b0\u7684\u8bf7\u6c42\uff0c\u65e7\u8bf7\u6c42\u81ea\u52a8\u4e22\u5f03 request_close \u53ef\u4ee5\u5224\u65ad\u54cd\u5e94\u662f\u5426\u7b26\u5408\u9884\u671f\uff0c\u6216\u8005\u76f4\u63a5 return \u65b0\u7684\u8bf7\u6c42\uff0c\u65e7\u8bf7\u6c42\u81ea\u52a8\u4e22\u5f03 \u63d0\u793a\uff1a \u5206\u5e03\u5f0f\u722c\u866b\u65f6\uff0c\u8bbe\u7f6e\u5f00\u542f\u4ee5\u4e0b\u4e24\u4e2a\u9009\u9879\uff0c\u5373\u53ef\u81ea\u52a8\u4fdd\u5b58\u9519\u8bef\u8bf7\u6c42\uff0c\u5e76\u5b58\u653e redis\uff0c\u4e0b\u6b21\u8bf7\u6c42\u81ea\u52a8\u7ee7\u7eed REQUEST_FAILED_SAVE = True # \u5206\u5e03\u5f0f\u65f6\u4fdd\u5b58\u5931\u8d25\u7684\u8bf7\u6c42\uff08\u91cd\u8bd5\u4e4b\u540e\u4ecd\u7136\u5931\u8d25\u7684\uff09 REQUEST_RETRY_FAILED = True # \u5206\u5e03\u5f0f\u65f6\u542f\u52a8\u91cd\u8bd5\u5931\u8d25\u8bf7\u6c42","title":"RequestMiddleware"},{"location":"middleware/#_3","text":"import palp from typing import Union from palp import settings from loguru import logger from palp.network.request import Request class RequestMiddleware(palp.RequestMiddleware): def request_in(self, spider, request) -> None: \"\"\" \u8bf7\u6c42\u8fdb\u5165\u65f6\u7684\u64cd\u4f5c :param spider: :param request: :return: \"\"\" if settings.REQUEST_PROXIES_TUNNEL_URL: request.proxies = { 'http': settings.REQUEST_PROXIES_TUNNEL_URL, 'https': settings.REQUEST_PROXIES_TUNNEL_URL, } def request_error(self, spider, request, exception: Exception) -> Union[Request, None]: \"\"\" \u8bf7\u6c42\u51fa\u9519\u65f6\u7684\u64cd\u4f5c :param spider: :param request: \u8be5\u53c2\u6570\u53ef\u8fd4\u56de\uff08\u7528\u4e8e\u653e\u5f03\u5f53\u524d\u8bf7\u6c42\uff0c\u5e76\u53d1\u8d77\u65b0\u8bf7\u6c42\uff09 :param exception: \u9519\u8bef\u7684\u8be6\u7ec6\u4fe1\u606f :return: [Request, None] \"\"\" logger.error(exception) return def request_failed(self, spider, request) -> None: \"\"\" \u8d85\u8fc7\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u65f6\u7684\u64cd\u4f5c :param spider: :param request: :return: \"\"\" logger.warning(f\"\u5931\u8d25\u7684\u8bf7\u6c42\uff1a{request}\") def request_close(self, spider, request, response) -> Union[Request, None]: \"\"\" \u8bf7\u6c42\u7ed3\u675f\u65f6\u7684\u64cd\u4f5c :param spider: :param request: \u8be5\u53c2\u6570\u53ef\u8fd4\u56de\uff08\u7528\u4e8e\u653e\u5f03\u5f53\u524d\u8bf7\u6c42\uff0c\u5e76\u53d1\u8d77\u65b0\u8bf7\u6c42\uff09 :param response: :return: [Request, None] \"\"\" return def request_record(self, spider, record: dict) -> None: \"\"\" \u8bf7\u6c42\u7ed3\u679c\u8bb0\u5f55\uff08\u5728 spider \u7ed3\u675f\u65f6\u8c03\u7528\uff09 :param spider: :param record: :return: \"\"\" logger.info(\"{} \u6267\u884c\u5b8c\u6bd5\uff0c\u8bf7\u6c42\u91cf\u7edf\u8ba1\uff1a{}\", spider.spider_name, record)","title":"\u7ed3\u6784"},{"location":"middleware/#_4","text":"\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 1 \u4ee3\u8868\u987a\u5e8f REQUEST_MIDDLEWARE = { 1: \"middlewares.middleware.RequestMiddleware\", }","title":"\u8bbe\u7f6e"},{"location":"middleware/#_5","text":"\u6ce8\u610f\uff1a\u8fd9\u91cc\u57fa\u4e8e\u9ed8\u8ba4\u7684 ResponseDownloaderByRequests \u8bf7\u6c42\u5668\uff08requests\uff09 class RequestMiddleware(palp.RequestMiddleware): def request_in(self, spider, request) -> None: \"\"\" \u8bf7\u6c42\u8fdb\u5165\u65f6\u7684\u64cd\u4f5c :param spider: :param request: :return: \"\"\" # \u7ed9\u6240\u6709 url \u90fd\u6dfb\u52a0\u4ee3\u7406 if settings.REQUEST_PROXIES_TUNNEL_URL and not request.proxies: request.proxies = { 'http': settings.REQUEST_PROXIES_TUNNEL_URL, 'https': settings.REQUEST_PROXIES_TUNNEL_URL, } # \u6307\u5b9a\u57df\u540d\u6dfb\u52a0\u4ee3\u7406 allow_domains = ['xxx'] if settings.REQUEST_PROXIES_TUNNEL_URL and not request.proxies: if request.domain in allow_domains: request.proxies = { 'http': settings.REQUEST_PROXIES_TUNNEL_URL, 'https': settings.REQUEST_PROXIES_TUNNEL_URL, }","title":"\u6dfb\u52a0\u4ee3\u7406"},{"location":"other/","text":"Other \u589e\u91cf\u722c\u866b \u589e\u91cf\u65e0\u975e\u5c31\u662f\u5224\u65ad\uff0c\u5efa\u8bae\u62ff\u4e3b\u952e\u76f4\u63a5\u5224\u65ad\uff0c\u4e0b\u9762\u6709\u4e24\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50 \u589e\u91cf\u4e00\u5b9a\u8981\u5224\u65ad\u4f55\u65f6\u4e0d\u7ffb\u9875\uff08\u7ee7\u7eed\uff09\uff0c\u4e0d\u7136\u767d\u767d\u6d6a\u8d39\u65f6\u95f4\uff0c\u4e0d\u80fd\u4f9d\u4ed7\u53bb\u91cd \u6570\u636e\u5e93\u5224\u65ad \u5373\u901a\u8fc7\u81ea\u5df1\u4fdd\u5b58\u7684\u6570\u636e\uff0c\u8fdb\u884c\u5224\u65ad\u5217\u8868\u9875\uff0c\u5df2\u51fa\u73b0\u7684 url \u5219\u4e3a\u5df2\u6293\u53d6\uff0c\u90a3\u4e48\u540e\u7eed\u5219\u4e0d\u9700\u8981\u6293\u53d6 \u3010\u6848\u4f8b\u3011 is_repeat = False # \u91cd\u590d\u6807\u5fd7 for i in response.xpath('//ul[@class=\"list_con\"]//li'): notice_url = response.urljoin(i.xpath('./a/@href').extract_first()) # \u5224\u65ad\u662f\u5426\u91cd\u590d if conn_company_notice.find_one({'notice_url': notice_url}): is_repeat = True break yield palp.RequestGet(url=notice_url, callback=self.parse_content) # \u7ffb\u9875 if not is_repeat and page_now < page_total: pass redis \u5224\u65ad\uff08\u4e0d\u63a8\u8350\uff09 Palp \u9ed8\u8ba4\u7684\u5206\u5e03\u5f0f\u53bb\u91cd\u6709\uff1a redis set \u53bb\u91cd redis bloom \u53bb\u91cd\uff08\u9ed8\u8ba4\uff09 \u5bf9\u5e94\u7684\u8fc7\u6ee4\u5668\u5982\u4e0b\uff1a RedisSetFilter\uff1a\u5bf9\u5e94 redis set \u53bb\u91cd RedisBloomFilter\uff1a\u5bf9\u5e94 redis bloom \u53bb\u91cd \u4f7f\u7528\u65f6\u9700\u5f00\u542f\u4ee5\u4e0b\u8bbe\u7f6e\uff0c\u4f5c\u7528\u662f\u5f00\u542f\u53bb\u91cd\u5e76\u6301\u4e45\u5316 FILTER_REQUEST = True PERSISTENCE_REQUEST_FILTER = True \u3010\u6848\u4f8b\u3011\u4ee5 redis bloom \u53bb\u91cd \u4e3a\u4f8b from palp.filter import RequestRedisBloomFilter is_repeat = False # \u91cd\u590d\u6807\u5fd7 for i in response.xpath('//ul[@class=\"list_con\"]//li'): notice_url = response.urljoin(i.xpath('./a/@href').extract_first()) req = palp.RequestGet(url=notice_url, callback=self.parse_content) # \u5224\u65ad\u662f\u5426\u91cd\u590d if RequestRedisBloomFilter().is_repeat(req): break yield req # \u7ffb\u9875 if not is_repeat and page_now < page_total: pass \u5feb\u901f\u4e8c\u6b21\u8bf7\u6c42 \u57fa\u4e8e\u4e0a\u4e00\u6b21\u8bf7\u6c42\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u4e8c\u6b21\u8bf7\u6c42 \u6709\u4e24\u79cd\u65b9\u6cd5\uff1a \u539f\u5730\u4fee\u6539 request \u7684 to_dict() \u65b9\u6cd5\u83b7\u53d6\u5b57\u5178\u540e\u4fee\u6539 \u539f\u5730\u4fee\u6539 def parse(self, request, response) -> None: request.xxx = xxx # \u4fee\u6539 yield request to_dict() request_dict = request.to_dict() request_dict[xxx] = xxx # \u4fee\u6539 yield palp.Request(**request_dict) \u4e2a\u6027\u5316\u722c\u866b \u6bd4\u5982\u6279\u6b21\u722c\u866b\uff0c\u6839\u636e redis \u83b7\u53d6\u4efb\u52a1\uff0c\u5176\u5b9e\u5f88\u7b80\u5355\u7684\uff08\u4ec5\u5185\u7f6e mysql \u6279\u6b21\u722c\u53d6\u722c\u866b\uff09 \u5173\u4e8e\u8868 \u53ef\u4ee5\u8bbe\u7f6e\u591a\u79cd\u72b6\u6001\uff1a\u5df2\u6293\u53d6\uff0c\u5f85\u6293\u53d6\uff0c\u961f\u5217\u4e2d\uff0c\u7b49\u7b49 \u5927\u6982\u6d41\u7a0b\u5982\u4e0b\uff1a \u4e0d\u8bba\u4f60\u4ec0\u4e48\u9700\u6c42\uff0c\u53ea\u8981\u5728 start_requests \u51fd\u6570\u4e2d\uff0c\u8bbe\u7f6e\u83b7\u53d6\u65b9\u6cd5 \u968f\u540e\u8bbe\u7f6e\u4e3a\u961f\u5217\u4e2d\uff08\u722c\u53d6\u4e2d\uff09\u72b6\u6001 \u5728 pipeline \u4e2d\uff08\u83b7\u53d6\u5230\u7ed3\u679c\u65f6\uff09\u8bbe\u7f6e\u4fee\u6539\u5df2\u722c\u53d6\u72b6\u6001 \u5173\u4e8e redis \u53ef\u4ee5\u8bbe\u7f6e\u6700\u7b80\u5355\u7684 list\u3001\u6216\u8005\u4e0d\u91cd\u590d\u7684 set \u6216\u8005\u4f18\u5148\u7ea7\u7684 zset \u53ea\u8981\u5728 start_requests \u51fd\u6570\u4e2d \u76f4\u63a5\u6267\u884c\u5bf9\u5e94\u7684 pop \u65b9\u6cd5\u5c31\u884c","title":"Other"},{"location":"other/#other","text":"","title":"Other"},{"location":"other/#_1","text":"\u589e\u91cf\u65e0\u975e\u5c31\u662f\u5224\u65ad\uff0c\u5efa\u8bae\u62ff\u4e3b\u952e\u76f4\u63a5\u5224\u65ad\uff0c\u4e0b\u9762\u6709\u4e24\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50 \u589e\u91cf\u4e00\u5b9a\u8981\u5224\u65ad\u4f55\u65f6\u4e0d\u7ffb\u9875\uff08\u7ee7\u7eed\uff09\uff0c\u4e0d\u7136\u767d\u767d\u6d6a\u8d39\u65f6\u95f4\uff0c\u4e0d\u80fd\u4f9d\u4ed7\u53bb\u91cd","title":"\u589e\u91cf\u722c\u866b"},{"location":"other/#_2","text":"\u5373\u901a\u8fc7\u81ea\u5df1\u4fdd\u5b58\u7684\u6570\u636e\uff0c\u8fdb\u884c\u5224\u65ad\u5217\u8868\u9875\uff0c\u5df2\u51fa\u73b0\u7684 url \u5219\u4e3a\u5df2\u6293\u53d6\uff0c\u90a3\u4e48\u540e\u7eed\u5219\u4e0d\u9700\u8981\u6293\u53d6 \u3010\u6848\u4f8b\u3011 is_repeat = False # \u91cd\u590d\u6807\u5fd7 for i in response.xpath('//ul[@class=\"list_con\"]//li'): notice_url = response.urljoin(i.xpath('./a/@href').extract_first()) # \u5224\u65ad\u662f\u5426\u91cd\u590d if conn_company_notice.find_one({'notice_url': notice_url}): is_repeat = True break yield palp.RequestGet(url=notice_url, callback=self.parse_content) # \u7ffb\u9875 if not is_repeat and page_now < page_total: pass","title":"\u6570\u636e\u5e93\u5224\u65ad"},{"location":"other/#redis","text":"Palp \u9ed8\u8ba4\u7684\u5206\u5e03\u5f0f\u53bb\u91cd\u6709\uff1a redis set \u53bb\u91cd redis bloom \u53bb\u91cd\uff08\u9ed8\u8ba4\uff09 \u5bf9\u5e94\u7684\u8fc7\u6ee4\u5668\u5982\u4e0b\uff1a RedisSetFilter\uff1a\u5bf9\u5e94 redis set \u53bb\u91cd RedisBloomFilter\uff1a\u5bf9\u5e94 redis bloom \u53bb\u91cd \u4f7f\u7528\u65f6\u9700\u5f00\u542f\u4ee5\u4e0b\u8bbe\u7f6e\uff0c\u4f5c\u7528\u662f\u5f00\u542f\u53bb\u91cd\u5e76\u6301\u4e45\u5316 FILTER_REQUEST = True PERSISTENCE_REQUEST_FILTER = True \u3010\u6848\u4f8b\u3011\u4ee5 redis bloom \u53bb\u91cd \u4e3a\u4f8b from palp.filter import RequestRedisBloomFilter is_repeat = False # \u91cd\u590d\u6807\u5fd7 for i in response.xpath('//ul[@class=\"list_con\"]//li'): notice_url = response.urljoin(i.xpath('./a/@href').extract_first()) req = palp.RequestGet(url=notice_url, callback=self.parse_content) # \u5224\u65ad\u662f\u5426\u91cd\u590d if RequestRedisBloomFilter().is_repeat(req): break yield req # \u7ffb\u9875 if not is_repeat and page_now < page_total: pass","title":"redis \u5224\u65ad\uff08\u4e0d\u63a8\u8350\uff09"},{"location":"other/#_3","text":"\u57fa\u4e8e\u4e0a\u4e00\u6b21\u8bf7\u6c42\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u4e8c\u6b21\u8bf7\u6c42 \u6709\u4e24\u79cd\u65b9\u6cd5\uff1a \u539f\u5730\u4fee\u6539 request \u7684 to_dict() \u65b9\u6cd5\u83b7\u53d6\u5b57\u5178\u540e\u4fee\u6539","title":"\u5feb\u901f\u4e8c\u6b21\u8bf7\u6c42"},{"location":"other/#_4","text":"def parse(self, request, response) -> None: request.xxx = xxx # \u4fee\u6539 yield request","title":"\u539f\u5730\u4fee\u6539"},{"location":"other/#to_dict","text":"request_dict = request.to_dict() request_dict[xxx] = xxx # \u4fee\u6539 yield palp.Request(**request_dict)","title":"to_dict()"},{"location":"other/#_5","text":"\u6bd4\u5982\u6279\u6b21\u722c\u866b\uff0c\u6839\u636e redis \u83b7\u53d6\u4efb\u52a1\uff0c\u5176\u5b9e\u5f88\u7b80\u5355\u7684\uff08\u4ec5\u5185\u7f6e mysql \u6279\u6b21\u722c\u53d6\u722c\u866b\uff09","title":"\u4e2a\u6027\u5316\u722c\u866b"},{"location":"other/#_6","text":"\u53ef\u4ee5\u8bbe\u7f6e\u591a\u79cd\u72b6\u6001\uff1a\u5df2\u6293\u53d6\uff0c\u5f85\u6293\u53d6\uff0c\u961f\u5217\u4e2d\uff0c\u7b49\u7b49 \u5927\u6982\u6d41\u7a0b\u5982\u4e0b\uff1a \u4e0d\u8bba\u4f60\u4ec0\u4e48\u9700\u6c42\uff0c\u53ea\u8981\u5728 start_requests \u51fd\u6570\u4e2d\uff0c\u8bbe\u7f6e\u83b7\u53d6\u65b9\u6cd5 \u968f\u540e\u8bbe\u7f6e\u4e3a\u961f\u5217\u4e2d\uff08\u722c\u53d6\u4e2d\uff09\u72b6\u6001 \u5728 pipeline \u4e2d\uff08\u83b7\u53d6\u5230\u7ed3\u679c\u65f6\uff09\u8bbe\u7f6e\u4fee\u6539\u5df2\u722c\u53d6\u72b6\u6001","title":"\u5173\u4e8e\u8868"},{"location":"other/#redis_1","text":"\u53ef\u4ee5\u8bbe\u7f6e\u6700\u7b80\u5355\u7684 list\u3001\u6216\u8005\u4e0d\u91cd\u590d\u7684 set \u6216\u8005\u4f18\u5148\u7ea7\u7684 zset \u53ea\u8981\u5728 start_requests \u51fd\u6570\u4e2d \u76f4\u63a5\u6267\u884c\u5bf9\u5e94\u7684 pop \u65b9\u6cd5\u5c31\u884c","title":"\u5173\u4e8e redis"},{"location":"pipeline/","text":"Pipeline \u5904\u7406 item\uff0c\u6e05\u6d17\u3001\u5165\u5e93 pipeline_in\uff1a\u6570\u636e\u8fdb\u5165\u65f6\uff0c\u4e00\u822c\u7528\u4f5c\u6e05\u6d17 pipeline_save\uff1a\u6570\u636e\u4fdd\u5b58\u65b9\u6cd5\uff0c\u4e00\u79cd\u4fdd\u5b58\u5199\u4e00\u4e2a\u6e05\u6670\u660e\u4e86 pipeline_error\uff1a\u6570\u636e\u4fdd\u5b58\u51fa\u9519\u65f6\uff0c\u9ed8\u8ba4\u91cd\u8bd5\u6b21\u6570 3 \uff0c\u53ef\u901a\u8fc7 settings.PIPELINE_RETRY_TIMES \u8bbe\u7f6e pipeline_failed\uff1a\u6570\u636e\u4fdd\u5b58\u51fa\u9519\u8d85\u8fc7\u6700\u5927\u6b21\u6570 pipeline_close\uff1a\u65e0\u6570\u636e\u65f6\uff0c\u6574\u4e2a pipeline \u7ed3\u675f\u65f6\u8fd0\u884c\uff01\uff01\uff01 \u6ce8\u610f\uff1a \u6570\u636e\u90fd\u662f\u539f\u5730\u4fee\u6539\u7684\uff0c\u4e0d\u9700\u8981\u4f20\u9012 \u9ed8\u8ba4\u542f\u52a8\u7684\u6570\u636e\u5904\u7406\u7ebf\u7a0b\u662f 5\uff0c\u53ef\u901a\u8fc7 settings.ITEM_THREADS \u8c03\u6574 \u9ed8\u8ba4\u662f\u5355\u6761\u4f20\u9012\uff0c\u6709\u591a\u6761\u4f20\u9012\u9700\u6c42\u7684\u53ef\u901a\u8fc7 settings.PIPELINE_ITEM_BUFFER \u8c03\u6574\uff0c\u8fd9\u6837\u4f20\u9012 item \u7684\u5c31\u662f\u5217\u8868 \u4e0d\u9700\u8981\u7684 item \u53ef\u4ee5\u901a\u8fc7 DropItemException \u8fdb\u884c\u4e22\u5f03\uff0c\u4f46\u5982\u679c\u662f\u591a\u6761\u76f4\u63a5\u5728 item \u5217\u8868\u79fb\u9664\u5c31\u884c\uff0c\u4e22\u5f03\u7684\u8bdd\u6574\u4e2a\u90fd\u4f1a\u88ab\u4e22\u6389 \u7ed3\u6784 import palp from loguru import logger class Pipeline(palp.Pipeline): def pipeline_in(self, spider, item) -> None: \"\"\" \u5165\u5e93\u4e4b\u524d\u7684\u64cd\u4f5c\uff0c\u4e00\u822c\u662f\u6e05\u6d17 :param spider: :param item: :return: \"\"\" def pipeline_save(self, spider, item) -> None: \"\"\" \u5165\u5e93 :param spider: :param item: \u542f\u7528 item_buffer \u5c06\u4f1a\u662f List[item] \u53cd\u4e4b\u4e3a item :return: \"\"\" logger.info(item) def pipeline_error(self, spider, item, exception: Exception) -> None: \"\"\" \u5165\u5e93\u51fa\u9519\u65f6\u7684\u64cd\u4f5c :param spider: :param item: \u542f\u7528 item buffer \u65f6\u662f List[item] :param exception: \u9519\u8bef\u7684\u8be6\u7ec6\u4fe1\u606f :return: \"\"\" logger.error(exception) def pipeline_failed(self, spider, item) -> None: \"\"\" \u8d85\u8fc7\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u65f6\u7684\u64cd\u4f5c :param spider: :param item: \u542f\u7528 item buffer \u65f6\u662f List[item] :return: \"\"\" logger.warning(f\"\u5931\u8d25\u7684 item\uff1a{item}\") def pipeline_close(self, spider) -> None: \"\"\" spider \u7ed3\u675f\u65f6\u7684\u64cd\u4f5c :param spider: :return: \"\"\" \u8bbe\u7f6e \u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 1 \u4ee3\u8868\u987a\u5e8f PIPELINE = { 1: \"pipelines.pipeline.Pipeline\", }","title":"Pipeline"},{"location":"pipeline/#pipeline","text":"\u5904\u7406 item\uff0c\u6e05\u6d17\u3001\u5165\u5e93 pipeline_in\uff1a\u6570\u636e\u8fdb\u5165\u65f6\uff0c\u4e00\u822c\u7528\u4f5c\u6e05\u6d17 pipeline_save\uff1a\u6570\u636e\u4fdd\u5b58\u65b9\u6cd5\uff0c\u4e00\u79cd\u4fdd\u5b58\u5199\u4e00\u4e2a\u6e05\u6670\u660e\u4e86 pipeline_error\uff1a\u6570\u636e\u4fdd\u5b58\u51fa\u9519\u65f6\uff0c\u9ed8\u8ba4\u91cd\u8bd5\u6b21\u6570 3 \uff0c\u53ef\u901a\u8fc7 settings.PIPELINE_RETRY_TIMES \u8bbe\u7f6e pipeline_failed\uff1a\u6570\u636e\u4fdd\u5b58\u51fa\u9519\u8d85\u8fc7\u6700\u5927\u6b21\u6570 pipeline_close\uff1a\u65e0\u6570\u636e\u65f6\uff0c\u6574\u4e2a pipeline \u7ed3\u675f\u65f6\u8fd0\u884c\uff01\uff01\uff01 \u6ce8\u610f\uff1a \u6570\u636e\u90fd\u662f\u539f\u5730\u4fee\u6539\u7684\uff0c\u4e0d\u9700\u8981\u4f20\u9012 \u9ed8\u8ba4\u542f\u52a8\u7684\u6570\u636e\u5904\u7406\u7ebf\u7a0b\u662f 5\uff0c\u53ef\u901a\u8fc7 settings.ITEM_THREADS \u8c03\u6574 \u9ed8\u8ba4\u662f\u5355\u6761\u4f20\u9012\uff0c\u6709\u591a\u6761\u4f20\u9012\u9700\u6c42\u7684\u53ef\u901a\u8fc7 settings.PIPELINE_ITEM_BUFFER \u8c03\u6574\uff0c\u8fd9\u6837\u4f20\u9012 item \u7684\u5c31\u662f\u5217\u8868 \u4e0d\u9700\u8981\u7684 item \u53ef\u4ee5\u901a\u8fc7 DropItemException \u8fdb\u884c\u4e22\u5f03\uff0c\u4f46\u5982\u679c\u662f\u591a\u6761\u76f4\u63a5\u5728 item \u5217\u8868\u79fb\u9664\u5c31\u884c\uff0c\u4e22\u5f03\u7684\u8bdd\u6574\u4e2a\u90fd\u4f1a\u88ab\u4e22\u6389","title":"Pipeline"},{"location":"pipeline/#_1","text":"import palp from loguru import logger class Pipeline(palp.Pipeline): def pipeline_in(self, spider, item) -> None: \"\"\" \u5165\u5e93\u4e4b\u524d\u7684\u64cd\u4f5c\uff0c\u4e00\u822c\u662f\u6e05\u6d17 :param spider: :param item: :return: \"\"\" def pipeline_save(self, spider, item) -> None: \"\"\" \u5165\u5e93 :param spider: :param item: \u542f\u7528 item_buffer \u5c06\u4f1a\u662f List[item] \u53cd\u4e4b\u4e3a item :return: \"\"\" logger.info(item) def pipeline_error(self, spider, item, exception: Exception) -> None: \"\"\" \u5165\u5e93\u51fa\u9519\u65f6\u7684\u64cd\u4f5c :param spider: :param item: \u542f\u7528 item buffer \u65f6\u662f List[item] :param exception: \u9519\u8bef\u7684\u8be6\u7ec6\u4fe1\u606f :return: \"\"\" logger.error(exception) def pipeline_failed(self, spider, item) -> None: \"\"\" \u8d85\u8fc7\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u65f6\u7684\u64cd\u4f5c :param spider: :param item: \u542f\u7528 item buffer \u65f6\u662f List[item] :return: \"\"\" logger.warning(f\"\u5931\u8d25\u7684 item\uff1a{item}\") def pipeline_close(self, spider) -> None: \"\"\" spider \u7ed3\u675f\u65f6\u7684\u64cd\u4f5c :param spider: :return: \"\"\"","title":"\u7ed3\u6784"},{"location":"pipeline/#_2","text":"\u6ce8\u610f\uff1a\u8fd9\u91cc\u7684 1 \u4ee3\u8868\u987a\u5e8f PIPELINE = { 1: \"pipelines.pipeline.Pipeline\", }","title":"\u8bbe\u7f6e"},{"location":"request/","text":"Request \u65b9\u6cd5 RequestGet RequestPost RequestDelete RequestOptions RequestHead RequestPatch \u53c2\u6570 meta\uff1a\u81ea\u52a8\u5411\u4e0b\u4f20\u9012\u53c2\u6570\uff0c\u4e0d\u9700\u8981\u624b\u52a8\u4f20\uff0c\u9700\u8981\u4e00\u4e2a\u5b57\u5178 filter_repeat\uff1a\u662f\u5426\u8fc7\u6ee4\u8bf7\u6c42\uff08\u9ed8\u8ba4\u4e0d\u8fc7\u6ee4\uff09 keep_session\uff1a\u662f\u5426\u4fdd\u6301 session \u81ea\u52a8 cookie\uff0ctls \u8fde\u63a5 keep_cookie\uff1a\u81ea\u52a8 cookieJar callback\uff1a\u56de\u8c03\u51fd\u6570\uff08\u5fc5\u987b\u6709\uff09 cookie_jar\uff1acookieJar\uff08\u81ea\u52a8\u521b\u5efa\u3001\u4f20\u9012\uff0c\u53ef\u901a\u8fc7\u6b64\u53c2\u6570\u83b7\u53d6 cookie\uff09 priority\uff1a\u4f7f\u7528\u4f18\u5148\u7ea7\u961f\u5217\u65f6\u7684\u4f18\u5148\u7ea7\uff08\u9ed8\u8ba4\uff09 downloader\uff1a\u81ea\u5b9a\u4e49\u7684\u4e0b\u8f7d\u5668\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 downloader_parser\uff1a\u81ea\u5b9a\u4e49\u7684\u4e0b\u8f7d\u89e3\u6790\u5668\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 command\uff1a\u81ea\u5b9a\u4e49\u4e0b\u8f7d\u5668\u65f6\u7684\u4f20\u53c2\u5b57\u5178 \u9664\u4e86 requests\u3001httpx \u53c2\u6570\u5e38\u7528\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 command \u6307\u5b9a\u5176\u5b83\u53c2\u6570\uff0c\u65b9\u4fbf\u81ea\u5b9a\u4e49\u8bf7\u6c42\u5668\u65f6\u4f7f\u7528 \u6ce8\u610f meta \u662f\u81ea\u52a8\u4f20\u9012\u7684\uff0c\u4e34\u65f6\u7684\u76f4\u63a5 xxx=yyy \u8bf7\u6c42\u8fc7\u6ee4\u9ed8\u8ba4\u662f\u4e0d\u5f00\u542f\u7684\uff0c\u9700\u8981\u5f00\u542f settings.FILTER_REQUEST\uff08\u666e\u901a\u8fc7\u6ee4\uff09 \u5728\u5f00\u542f\u666e\u901a\u8fc7\u6ee4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u9009\u62e9\u5f00\u542f settings.STRICT_FILTER\uff08\u4e25\u683c\u8fc7\u6ee4\uff09\u52a0\u9501\uff0c\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u4e0d\u63a8\u8350 keep_session \u867d\u7136\u53ef\u4ee5\u63d0\u9ad8\u90e8\u5206\u6548\u7387\uff0c\u4f46\u662f\u9664\u975e\u4f60\u5bf9 cookie \u8981\u6c42\u4e0d\u9ad8\uff0c\u5426\u5219\u5206\u5e03\u5f0f cookie \u65e0\u6cd5\u968f\u7740\u8bf7\u6c42\u53d1\u5230\u5176\u4ed6\u673a\u5668 keep_cookie \u63a8\u8350\uff0c\u7c7b\u4f3c scrapy \u624b\u52a8\u4f7f\u7528 cookiejar\uff0c\u8fd9\u91cc\u53ea\u8981\u4e00\u76f4 keep_cookie=True \u5c31\u884c \u8bf7\u6c42\u961f\u5217\u9ed8\u8ba4\u662f \u4f18\u5148\u7ea7\u961f\u5217\uff0c\u60f3\u4fee\u6539\u901a\u8fc7 settings.REQUEST_QUEUE_MODE \u4fee\u6539 \u4f18\u5148\u7ea7\u961f\u5217\uff0c\u672c\u8eab\u5c31\u6709\u8fc7\u6ee4\u91cd\u590d\u8bf7\u6c42\u7684\u4f5c\u7528\uff01\uff01\uff01 \u4f7f\u7528 meta \u53ea\u8981\u8bb0\u4f4f\u4e00\u70b9\uff0cmeta \u662f\u5728\u4e0a\u4e00\u4e2a\u8bf7\u6c42\u4e0a\u9762 # \u5220\u9664\u5b57\u6bb5 del request.meta[''] # \u6e05\u7a7a meta request.meta.clear() # \u66f4\u65b0 meta request.meta.update() # \u65b9\u6cd51 yield RequestGet(url='xxx', meta={'xxx': 'yyy'}) # \u65b9\u6cd52\uff1a\u8fd9\u91cc\u4f1a\u4e0e\u4e4b\u524d\u7684 meta \u8fdb\u884c\u5408\u5e76","title":"Request"},{"location":"request/#request","text":"","title":"Request"},{"location":"request/#_1","text":"RequestGet RequestPost RequestDelete RequestOptions RequestHead RequestPatch","title":"\u65b9\u6cd5"},{"location":"request/#_2","text":"meta\uff1a\u81ea\u52a8\u5411\u4e0b\u4f20\u9012\u53c2\u6570\uff0c\u4e0d\u9700\u8981\u624b\u52a8\u4f20\uff0c\u9700\u8981\u4e00\u4e2a\u5b57\u5178 filter_repeat\uff1a\u662f\u5426\u8fc7\u6ee4\u8bf7\u6c42\uff08\u9ed8\u8ba4\u4e0d\u8fc7\u6ee4\uff09 keep_session\uff1a\u662f\u5426\u4fdd\u6301 session \u81ea\u52a8 cookie\uff0ctls \u8fde\u63a5 keep_cookie\uff1a\u81ea\u52a8 cookieJar callback\uff1a\u56de\u8c03\u51fd\u6570\uff08\u5fc5\u987b\u6709\uff09 cookie_jar\uff1acookieJar\uff08\u81ea\u52a8\u521b\u5efa\u3001\u4f20\u9012\uff0c\u53ef\u901a\u8fc7\u6b64\u53c2\u6570\u83b7\u53d6 cookie\uff09 priority\uff1a\u4f7f\u7528\u4f18\u5148\u7ea7\u961f\u5217\u65f6\u7684\u4f18\u5148\u7ea7\uff08\u9ed8\u8ba4\uff09 downloader\uff1a\u81ea\u5b9a\u4e49\u7684\u4e0b\u8f7d\u5668\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 downloader_parser\uff1a\u81ea\u5b9a\u4e49\u7684\u4e0b\u8f7d\u89e3\u6790\u5668\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 command\uff1a\u81ea\u5b9a\u4e49\u4e0b\u8f7d\u5668\u65f6\u7684\u4f20\u53c2\u5b57\u5178 \u9664\u4e86 requests\u3001httpx \u53c2\u6570\u5e38\u7528\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 command \u6307\u5b9a\u5176\u5b83\u53c2\u6570\uff0c\u65b9\u4fbf\u81ea\u5b9a\u4e49\u8bf7\u6c42\u5668\u65f6\u4f7f\u7528","title":"\u53c2\u6570"},{"location":"request/#_3","text":"meta \u662f\u81ea\u52a8\u4f20\u9012\u7684\uff0c\u4e34\u65f6\u7684\u76f4\u63a5 xxx=yyy \u8bf7\u6c42\u8fc7\u6ee4\u9ed8\u8ba4\u662f\u4e0d\u5f00\u542f\u7684\uff0c\u9700\u8981\u5f00\u542f settings.FILTER_REQUEST\uff08\u666e\u901a\u8fc7\u6ee4\uff09 \u5728\u5f00\u542f\u666e\u901a\u8fc7\u6ee4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u9009\u62e9\u5f00\u542f settings.STRICT_FILTER\uff08\u4e25\u683c\u8fc7\u6ee4\uff09\u52a0\u9501\uff0c\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u4e0d\u63a8\u8350 keep_session \u867d\u7136\u53ef\u4ee5\u63d0\u9ad8\u90e8\u5206\u6548\u7387\uff0c\u4f46\u662f\u9664\u975e\u4f60\u5bf9 cookie \u8981\u6c42\u4e0d\u9ad8\uff0c\u5426\u5219\u5206\u5e03\u5f0f cookie \u65e0\u6cd5\u968f\u7740\u8bf7\u6c42\u53d1\u5230\u5176\u4ed6\u673a\u5668 keep_cookie \u63a8\u8350\uff0c\u7c7b\u4f3c scrapy \u624b\u52a8\u4f7f\u7528 cookiejar\uff0c\u8fd9\u91cc\u53ea\u8981\u4e00\u76f4 keep_cookie=True \u5c31\u884c \u8bf7\u6c42\u961f\u5217\u9ed8\u8ba4\u662f \u4f18\u5148\u7ea7\u961f\u5217\uff0c\u60f3\u4fee\u6539\u901a\u8fc7 settings.REQUEST_QUEUE_MODE \u4fee\u6539 \u4f18\u5148\u7ea7\u961f\u5217\uff0c\u672c\u8eab\u5c31\u6709\u8fc7\u6ee4\u91cd\u590d\u8bf7\u6c42\u7684\u4f5c\u7528\uff01\uff01\uff01","title":"\u6ce8\u610f"},{"location":"request/#meta","text":"\u53ea\u8981\u8bb0\u4f4f\u4e00\u70b9\uff0cmeta \u662f\u5728\u4e0a\u4e00\u4e2a\u8bf7\u6c42\u4e0a\u9762 # \u5220\u9664\u5b57\u6bb5 del request.meta[''] # \u6e05\u7a7a meta request.meta.clear() # \u66f4\u65b0 meta request.meta.update() # \u65b9\u6cd51 yield RequestGet(url='xxx', meta={'xxx': 'yyy'}) # \u65b9\u6cd52\uff1a\u8fd9\u91cc\u4f1a\u4e0e\u4e4b\u524d\u7684 meta \u8fdb\u884c\u5408\u5e76","title":"\u4f7f\u7528 meta"},{"location":"response/","text":"Response \u65b9\u6cd5 \u8bf7\u6c42\u54cd\u5e94 \u63d0\u4f9b\u4e86\u81ea\u5e26\u7684\u4ee5\u4e0b\u65b9\u6cd5 xpath css re re_first bs4\uff08\u9ed8\u8ba4\u89e3\u6790\u5668\uff1alxml\uff09 urljoin\uff1a\u5408\u5e76 url\uff0c\u53ef\u4ee5\u624b\u52a8\u4f7f\u7528\uff08\u9ed8\u8ba4\u4f1a\u81ea\u52a8\u5904\u7406\uff09 \u793a\u4f8b def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" response.bs4.find() response.re() response.re_first() response.xpath().extract() response.xpath().extract_first() \u81ea\u5b9a\u4e49\u8bf7\u6c42\u5668 \u6b65\u9aa4 \u5b9a\u4e49 downloader \u7c7b\u5e76\u7ee7\u627f palp.network.ResponseDownloader \u5b9e\u73b0 response \u65b9\u6cd5\uff0c\u5e76\u8fd4\u56de \u5b9a\u4e49 resoonse \u7c7b\u5e76\u7ee7\u627f palp.network.Response \u66f4\u6539\u8bbe\u7f6e\uff08\u5168\u5c40\uff09 \u8bf7\u6c42\u6dfb\u52a0\u53c2\u6570\uff08\u5c40\u90e8\uff09 \u5b9a\u4e49 downloader \u7c7b \u7ee7\u627f palp.network.ResponseDownloader \u6ce8\u610f\uff1a Request \u7c7b\u7684\u53c2\u6570\u90fd\u662f requests \u7684\uff0c\u4f46\u662f ResponseDownloader \u4e0d\u4f1a\u63a5\u6536\u5168\u90e8\u53c2\u6570\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f7f\u7528\u4e86 self.kwargs ResponseDownloader \u63a5\u6536\u7684\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7 command \u5b57\u5178\u8fdb\u884c\u63a5\u6536 \u8fd9\u91cc\u4ee5 requests \u4e3e\u4f8b \u9700\u8981\u5b9e\u73b0 keep_session \u65f6\u4f7f\u7528 session keep_cookie \u65f6\u4f7f\u7528 cookie_jar \u4e3b\u8981\u770b\u662f\u770b\u4f60\u5177\u4f53\u4f7f\u7528\u4ec0\u4e48\u53bb\u54cd\u5e94\uff0c\u5177\u4f53\u9700\u6c42\u5177\u4f53\u6784\u9020 \u6700\u540e\u8981\u8fd4\u56de\u54cd\u5e94 \"\"\" requests \u8bf7\u6c42\u5668 \"\"\" import requests from requests.adapters import HTTPAdapter from palp.network.downloader import ResponseDownloader class ResponseDownloaderByRequests(ResponseDownloader): \"\"\" \u9002\u7528\u4e8e requests \u7684\u8bf7\u6c42\u5668 \"\"\" SESSION = None def __new__(cls, *args, **kwargs): \"\"\" requests \u8bbe\u7f6e session :param args: :param kwargs: \"\"\" if cls.SESSION is None: cls.SESSION = requests.Session() # \u540c\u4e00 session \u9ed8\u8ba4\u8fde\u63a5\u6c60\u3001\u6700\u5927\u8fde\u63a5\u6570\u90fd\u662f 10\uff0c\u8fd9\u91cc\u6539\u4e3a 1000 cls.SESSION.mount(\"http\", HTTPAdapter(pool_connections=1000, pool_maxsize=1000)) return object.__new__(cls) def response(self): \"\"\" \u5904\u7406\u54cd\u5e94\u5e76\u8fd4\u56de :return: \"\"\" # \u83b7\u53d6\u8bf7\u6c42\u5668 if self.keep_session: request = self.session else: request = requests # \u662f\u5426\u4fdd\u6301 cookie if not self.keep_session and self.keep_cookie: self.cookies = self.cookie_jar return request.request( url=self.url, method=self.method, params=self.params, data=self.data, headers=self.headers, cookies=self.cookies, timeout=self.timeout, proxies=self.proxies, json=self.json, **self.kwargs ) \u5b9a\u4e49 Response \u7c7b \u7ee7\u627f palp.network.Response \u8fd9\u91cc\u4ee5 requests \u4e3e\u4f8b \u5b9e\u73b0\u4e0b\u9762\u7684\u65b9\u6cd5\uff0c\u5176\u4e2d text\u3001cookies\u3001url \u662f\u5fc5\u987b\u5b9e\u73b0\u7684 \u5176\u4f59\u7684\u53ef\u4ee5\u6839\u636e\u8981\u4ec0\u4e48\u5b9e\u73b0\u4ec0\u4e48 \"\"\" \u9002\u7528\u4e8e requests \u7684\u54cd\u5e94\u89e3\u6790\u5668 \"\"\" from palp.network.response import Response class RequestsResponse(Response): \"\"\" \u9002\u7528\u4e8e requests \u7684\u54cd\u5e94\u89e3\u6790\u5668 \"\"\" def __init__(self, resp): super().__init__(resp) @property def text(self) -> str: return self.content.decode(self.encoding) @property def content(self) -> bytes: return self.response.content def json(self, **kwargs) -> dict: return self.response.json(**kwargs) @property def status_code(self) -> int: return self.response.status_code @property def cookies(self) -> dict: return self.response.cookies.get_dict() @property def headers(self) -> dict: return dict(self.response.headers) @property def url(self) -> str: return self.response.url @property def history(self) -> list: \"\"\" \u54cd\u5e94 url :return: \"\"\" return self.response.history @property def links(self): \"\"\" :return: \"\"\" return self.response.links \u5168\u5c40\u4f7f\u7528 settings \u66f4\u6539 RESPONSE_DOWNLOADER = 'palp.network.downloader_requests.ResponseDownloaderByRequests' # \u8bf7\u6c42\u5668\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u662f requests RESPONSE_DOWNLOADER_PARSER = 'palp.network.response_requests.RequestsResponse' # \u89e3\u6790\u5668\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u662f requests \u5c40\u90e8\u4f7f\u7528 \u5f15\u5165\uff0c\u5e76\u5728 yield \u8bf7\u6c42\u7684\u65f6\u5019\u76f4\u63a5\u4f20\u9012\u5373\u53ef \u6ce8\u610f\uff1a\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316 yield RequestGet( downloader=ResponseDownloaderByRequests, downloader_parser=RequestsResponse )","title":"Response"},{"location":"response/#response","text":"","title":"Response"},{"location":"response/#_1","text":"\u8bf7\u6c42\u54cd\u5e94 \u63d0\u4f9b\u4e86\u81ea\u5e26\u7684\u4ee5\u4e0b\u65b9\u6cd5 xpath css re re_first bs4\uff08\u9ed8\u8ba4\u89e3\u6790\u5668\uff1alxml\uff09 urljoin\uff1a\u5408\u5e76 url\uff0c\u53ef\u4ee5\u624b\u52a8\u4f7f\u7528\uff08\u9ed8\u8ba4\u4f1a\u81ea\u52a8\u5904\u7406\uff09","title":"\u65b9\u6cd5"},{"location":"response/#_2","text":"def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" response.bs4.find() response.re() response.re_first() response.xpath().extract() response.xpath().extract_first()","title":"\u793a\u4f8b"},{"location":"response/#_3","text":"","title":"\u81ea\u5b9a\u4e49\u8bf7\u6c42\u5668"},{"location":"response/#_4","text":"\u5b9a\u4e49 downloader \u7c7b\u5e76\u7ee7\u627f palp.network.ResponseDownloader \u5b9e\u73b0 response \u65b9\u6cd5\uff0c\u5e76\u8fd4\u56de \u5b9a\u4e49 resoonse \u7c7b\u5e76\u7ee7\u627f palp.network.Response \u66f4\u6539\u8bbe\u7f6e\uff08\u5168\u5c40\uff09 \u8bf7\u6c42\u6dfb\u52a0\u53c2\u6570\uff08\u5c40\u90e8\uff09","title":"\u6b65\u9aa4"},{"location":"response/#downloader","text":"\u7ee7\u627f palp.network.ResponseDownloader \u6ce8\u610f\uff1a Request \u7c7b\u7684\u53c2\u6570\u90fd\u662f requests \u7684\uff0c\u4f46\u662f ResponseDownloader \u4e0d\u4f1a\u63a5\u6536\u5168\u90e8\u53c2\u6570\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f7f\u7528\u4e86 self.kwargs ResponseDownloader \u63a5\u6536\u7684\u53c2\u6570\u53ef\u4ee5\u901a\u8fc7 command \u5b57\u5178\u8fdb\u884c\u63a5\u6536 \u8fd9\u91cc\u4ee5 requests \u4e3e\u4f8b \u9700\u8981\u5b9e\u73b0 keep_session \u65f6\u4f7f\u7528 session keep_cookie \u65f6\u4f7f\u7528 cookie_jar \u4e3b\u8981\u770b\u662f\u770b\u4f60\u5177\u4f53\u4f7f\u7528\u4ec0\u4e48\u53bb\u54cd\u5e94\uff0c\u5177\u4f53\u9700\u6c42\u5177\u4f53\u6784\u9020 \u6700\u540e\u8981\u8fd4\u56de\u54cd\u5e94 \"\"\" requests \u8bf7\u6c42\u5668 \"\"\" import requests from requests.adapters import HTTPAdapter from palp.network.downloader import ResponseDownloader class ResponseDownloaderByRequests(ResponseDownloader): \"\"\" \u9002\u7528\u4e8e requests \u7684\u8bf7\u6c42\u5668 \"\"\" SESSION = None def __new__(cls, *args, **kwargs): \"\"\" requests \u8bbe\u7f6e session :param args: :param kwargs: \"\"\" if cls.SESSION is None: cls.SESSION = requests.Session() # \u540c\u4e00 session \u9ed8\u8ba4\u8fde\u63a5\u6c60\u3001\u6700\u5927\u8fde\u63a5\u6570\u90fd\u662f 10\uff0c\u8fd9\u91cc\u6539\u4e3a 1000 cls.SESSION.mount(\"http\", HTTPAdapter(pool_connections=1000, pool_maxsize=1000)) return object.__new__(cls) def response(self): \"\"\" \u5904\u7406\u54cd\u5e94\u5e76\u8fd4\u56de :return: \"\"\" # \u83b7\u53d6\u8bf7\u6c42\u5668 if self.keep_session: request = self.session else: request = requests # \u662f\u5426\u4fdd\u6301 cookie if not self.keep_session and self.keep_cookie: self.cookies = self.cookie_jar return request.request( url=self.url, method=self.method, params=self.params, data=self.data, headers=self.headers, cookies=self.cookies, timeout=self.timeout, proxies=self.proxies, json=self.json, **self.kwargs )","title":"\u5b9a\u4e49 downloader \u7c7b"},{"location":"response/#response_1","text":"\u7ee7\u627f palp.network.Response \u8fd9\u91cc\u4ee5 requests \u4e3e\u4f8b \u5b9e\u73b0\u4e0b\u9762\u7684\u65b9\u6cd5\uff0c\u5176\u4e2d text\u3001cookies\u3001url \u662f\u5fc5\u987b\u5b9e\u73b0\u7684 \u5176\u4f59\u7684\u53ef\u4ee5\u6839\u636e\u8981\u4ec0\u4e48\u5b9e\u73b0\u4ec0\u4e48 \"\"\" \u9002\u7528\u4e8e requests \u7684\u54cd\u5e94\u89e3\u6790\u5668 \"\"\" from palp.network.response import Response class RequestsResponse(Response): \"\"\" \u9002\u7528\u4e8e requests \u7684\u54cd\u5e94\u89e3\u6790\u5668 \"\"\" def __init__(self, resp): super().__init__(resp) @property def text(self) -> str: return self.content.decode(self.encoding) @property def content(self) -> bytes: return self.response.content def json(self, **kwargs) -> dict: return self.response.json(**kwargs) @property def status_code(self) -> int: return self.response.status_code @property def cookies(self) -> dict: return self.response.cookies.get_dict() @property def headers(self) -> dict: return dict(self.response.headers) @property def url(self) -> str: return self.response.url @property def history(self) -> list: \"\"\" \u54cd\u5e94 url :return: \"\"\" return self.response.history @property def links(self): \"\"\" :return: \"\"\" return self.response.links","title":"\u5b9a\u4e49 Response \u7c7b"},{"location":"response/#_5","text":"settings \u66f4\u6539 RESPONSE_DOWNLOADER = 'palp.network.downloader_requests.ResponseDownloaderByRequests' # \u8bf7\u6c42\u5668\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u662f requests RESPONSE_DOWNLOADER_PARSER = 'palp.network.response_requests.RequestsResponse' # \u89e3\u6790\u5668\uff0c\u8fd9\u91cc\u9ed8\u8ba4\u662f requests","title":"\u5168\u5c40\u4f7f\u7528"},{"location":"response/#_6","text":"\u5f15\u5165\uff0c\u5e76\u5728 yield \u8bf7\u6c42\u7684\u65f6\u5019\u76f4\u63a5\u4f20\u9012\u5373\u53ef \u6ce8\u610f\uff1a\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316 yield RequestGet( downloader=ResponseDownloaderByRequests, downloader_parser=RequestsResponse )","title":"\u5c40\u90e8\u4f7f\u7528"},{"location":"spider/","text":"Spider \u76ee\u524d\u63d0\u4f9b\u4ee5\u4e0b spider LocalSpider\uff1a\u672c\u5730\u722c\u866b DistributiveSpider\uff1a\u5206\u5e03\u5f0f\u722c\u866b CycleSpider\uff1a\u5468\u671f\u722c\u866b\uff08\u6839\u636e\u9700\u6c42\u53ef\u7ee7\u627f\u672c\u5730\u3001\u5206\u5e03\u5f0f\uff09 JumpSpider\uff1a\u8df3\u8f6c\u722c\u866b\uff08\u57fa\u4e8e\u5185\u5b58\u961f\u5217\uff0c\u7528\u4e8e\u9891\u7e41\u7684\u9a8c\u8bc1\u7801\u3001\u767b\u5f55\u7684\u786e\u8ba4\u66f4\u65b0 cookie\uff09 LocalSpider \u672c\u5730\u722c\u866b\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5f0f \u521b\u5efa \u6ce8\u610f\uff1a\u5728\u9879\u76ee\u76ee\u5f55\u4e0b\u6267\u884c palp create -s baidu 1 \u7ed3\u6784 \"\"\" Create on 2022-12-12 16:21:10.159221 ---------- @summary: ---------- @author: \"\"\" import palp class BaiduSpider(palp.LocalSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e def start_requests(self) -> None: \"\"\" \u8d77\u59cb\u51fd\u6570 :return: \"\"\" yield palp.RequestGet(\"https://www.baidu.com\") def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" print(response) if __name__ == '__main__': BaiduSpider().start() DistributiveSpider \u6ce8\u610f\uff1a \u5206\u5e03\u5f0f\u722c\u866b\uff0c\u9700\u8981\u5728\u8bbe\u7f6e\u4e2d\u589e\u52a0 redis \u8fde\u63a5 \u5206\u5e03\u5f0f\u722c\u866b\u9ed8\u8ba4\u4e3a\u4f18\u5148\u7ea7\u961f\u5217\uff0c\u672c\u8eab\u5177\u6709\u53bb\u91cd\u7684\u529f\u80fd\uff0c\u5982\u679c\u6709\u5927\u91cf\u5fc5\u8981\u7684\u91cd\u590d\u8bf7\u6c42\uff0c\u4fee\u6539 settings.REQUEST_QUEUE_MODE = 1 \u521b\u5efa palp create -s baidu 2 \u7ed3\u6784 \u548c\u666e\u901a\u7684\u722c\u866b\uff0c\u53ea\u662f\u7ee7\u627f\u7c7b\u4e0d\u540c\uff0c\u65e0\u6210\u672c\u5207\u6362 \"\"\" Create on 2022-12-12 16:21:10.159221 ---------- @summary: ---------- @author: \"\"\" import palp class BaiduSpider(palp.DistributiveSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e def start_requests(self) -> None: \"\"\" \u8d77\u59cb\u51fd\u6570 :return: \"\"\" yield palp.RequestGet(\"https://www.baidu.com\") def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" print(response) if __name__ == '__main__': BaiduSpider().start() borrow_request\u3001recycle_request \u76ee\u524d\u6846\u67b6\u662f\u6839\u636e\u4ee5\u4e0a\u4e24\u4e2a\u51fd\u6570\u5b9e\u73b0 cookie_jar \u5171\u4eab\u529f\u80fd\uff08\u53ef\u81ea\u5b9a\u4e49\uff09 borrow_request\uff1a\u51b3\u5b9a\u5728\u4ec0\u4e48\u65f6\u5019\u501f\u7528\u5171\u4eab\u7684\u53c2\u6570 recycle_request\uff1a\u51b3\u5b9a\u5728\u6267\u884c\u5b8c\u6bd5\u65f6\uff0c\u5171\u4eab\u4ec0\u4e48\u53c2\u6570 \u5728\u5904\u7406\u6279\u6b21\u4efb\u52a1\u65f6\uff0c\u53ef\u80fd\u4e00\u6b21\u4f1a\u6709\u5f88\u591a\u4efb\u52a1\uff0c\u5bf9\u6bcf\u4e2a\u4efb\u52a1\u90fd\u53bb\u91cd\u65b0\u8bf7\u6c42\uff0c\u83b7\u53d6 cookie \u7684\u8bdd\uff08\u6307\u7684\u662f\u767b\u5f55\u3001\u9a8c\u8bc1\u7801\u7b49\u83b7\u53d6\u5fc5\u8981 cookie\uff09\u5c06\u4f1a\u662f\u707e\u96be \u6240\u4ee5\u8fd9\u91cc\u89e3\u51b3 cookie \u590d\u7528\uff0c\u5f53\u7136\u8981\u505a\u597d cookie \u5931\u6548\u7684\u5224\u65ad\uff0c\u5e76\u91cd\u65b0\u767b\u5f55\uff08\u53ef\u5728 middleware \u5224\u65ad\uff0c\u5e76\u76f4\u63a5\u8fd4\u56de\u542b\u6709 jumpspider \u7684\u8bf7\u6c42\uff09 settings \u5f00\u542f REQUEST_BORROW = False # \u5206\u53d1\u5927\u91cf\u4efb\u52a1\u65f6\uff0c\u9700\u8981\u5728\u8bf7\u6c42\u4e2d\u4f20\u9012\u7684\u53c2\u6570\uff08\u9ed8\u8ba4\u56de\u6536 cookie \u590d\u7528\uff09 REQUEST_BORROW_DELETE_WHEN_START = True # \u542f\u52a8\u65f6\u5220\u9664\u6240\u6709 BORROW\uff08\u975e\u5206\u5e03\u5f0f\u662f\u5728\u5185\u5b58\u91cc\uff0c\u8be5\u9009\u9879\u5ffd\u7565\uff09 spider \u56de\u6536 \u56e0\u4e3a spider \u5185\u65e0\u6cd5\u5224\u65ad\u662f\u5426\u662f\u6700\u540e\u4e00\u4e2a\u8bf7\u6c42\uff0c\u6240\u4ee5\u9700\u8981\u4e3b\u52a8\u56de\u6536 self.recycle_request(request=request) middleware \u5224\u65ad \u6ce8\u610f\uff1a\u8fd9\u53ea\u662f\u4e2a\u6848\u4f8b \u8be5\u6848\u4f8b\u662f\u5728\u8bf7\u6c42\u7ed3\u675f\u65f6\uff0c\u5224\u65ad\u5230\u5f53\u524d\u72b6\u6001\u4e0d\u5bf9\uff0c\u968f\u540e\u4fee\u6539\u8bf7\u6c42\uff0c\u8df3\u8f6c\u767b\u5f55\uff0c\u653e\u5f03\u539f\u8bf7\u6c42\u7684\u540c\u65f6\uff0c\u53d1\u51fa\u65b0\u7684\u8bf7\u6c42 def request_close(self, spider, request, response): if response.status_code != 200: request.jump_spider = LoginJumpSpider request.jump_request_middleware = ProxyRequestMiddleware return request \u6848\u4f8b \"\"\" Create on 2023-01-03 10:45:25.681820 ---------- @summary: ---------- @author: \"\"\" import palp class BaiduLocalSpider(palp.DistributiveSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e def start_requests(self) -> None: \"\"\" \u8d77\u59cb\u51fd\u6570 :return: \"\"\" yield palp.RequestGet(\"https://www.baidu.com\", keep_cookie=True) yield palp.RequestGet(\"https://www.baidu.com\", keep_cookie=True) def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" print(request.cookie_jar.get_cookie()) # \u53ef\u4ee5\u770b\u5230\u4e24\u6b21\u662f\u4e00\u6837\u7684 cookie self.recycle_request(request=request) if __name__ == '__main__': BaiduLocalSpider(thread_count=1).start() CycleSpider \u5468\u671f\u722c\u866b\uff0c\u4f7f\u7528 mysql \u521b\u5efa\u4efb\u52a1\u8868\uff0c\u5e76\u5728\u722c\u866b\u5185\u90e8\u83b7\u53d6\u8fdb\u884c\u6293\u53d6 \u4e2a\u4eba\u8ba4\u4e3a\uff0c\u4efb\u52a1\u9700\u6c42\u662f\u591a\u6837\u5316\u7684\uff0c\u6240\u4ee5\u4efb\u52a1\u8868\u7684 task \u5b57\u6bb5\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u5e76\u4e14\u83b7\u53d6\u7684\u4efb\u52a1\u662f\u5168\u8868\u5b57\u6bb5\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u81ea\u5b9a\u4e49\u90e8\u5206\u8868\u5b57\u6bb5\uff0c\u5b9e\u73b0\u66f4\u591a\u9700\u6c42 \u6ce8\u610f\uff1a \u7ee7\u627f\u5468\u671f\u722c\u866b\u7684\u3010\u540c\u65f6\u9700\u8981\u7ee7\u627f \u5206\u5e03\u5f0f \u6216 \u672c\u5730\u722c\u866b\u3011\u624d\u53ef\u4ee5\u6267\u884c \u624b\u52a8\u5bfc\u5165\u4e2d\u95f4\u4ef6\uff1apalp.middleware.CycleSpiderRecordMiddleware\uff08\u4e0d\u9700\u8981 record \u8868\uff0c\u4e0d\u9700\u8981\u4f20\u9012 task_id \u65f6\u6846\u67b6\u8bbe\u7f6e\u5df2\u722c\u53d6\uff0c\u53ef\u4ee5\u4e0d\u8981\uff0c\u81ea\u5df1\u7ef4\u62a4\u5c31\u884c\u4e86\uff09 \u8bb0\u5f55\u4e2d\u95f4\u4ef6\u4f1a\uff1a\u81ea\u52a8\u4fee\u6539\u5931\u8d25\u3001\u6210\u529f\u7684\u4efb\u52a1\u72b6\u6001\uff08request \u4f20\u9012 task_id \u65f6\uff0c\u6216\u81ea\u5df1\u8c03\u7528\uff09 \u8bb0\u5f55\u4e2d\u95f4\u4ef6\u4f1a\uff1a\u81ea\u52a8\u5728\u8bb0\u5f55\u8868\u4e2d\u6dfb\u52a0\u3001\u4fee\u6539\u4efb\u52a1\u6267\u884c\u60c5\u51b5 \u542b\u6709\u4ee5\u4e0b\u65b9\u6cd5\uff1a \u65b9\u6cd5 \u8bf4\u660e initialize_all_task_states \u91cd\u7f6e\u6240\u6709\u4efb\u52a1\u72b6\u6001\u4e3a 0 get_tasks \u6839\u636e\u6307\u5b9a\u72b6\u6001\u83b7\u53d6\u4efb\u52a1 get_tasks_state0 \u83b7\u53d6\u72b6\u6001\u4e3a 0 \u7684\u4efb\u52a1 get_tasks_state2 \u83b7\u53d6\u72b6\u6001\u4e3a 2 \u7684\u4efb\u52a1 set_task_state \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u7684\u72b6\u6001 set_task_state_running \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u72b6\u6001\u4e3a 1 set_task_state_done \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u72b6\u6001\u4e3a 2 set_task_state_failed \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u72b6\u6001\u4e3a 3 create_mysql_table \u521b\u5efa\u4efb\u52a1\u8868\u3001\u8bb0\u5f55\u8868 check_mysql_table_exists \u68c0\u67e5\u8868\u662f\u5426\u5b58\u5728 insert_tasks \u63d2\u5165\u4efb\u52a1\uff08\u5b57\u7b26\u4e32\u6216\u5b57\u7b26\u4e32\u5217\u8868\uff09 insert_task_record_start \u521b\u5efa\u8bb0\u5f55\u8868\u7684\u521d\u59cb\u8bb0\u5f55 update_task_record \u66f4\u65b0\u8bb0\u5f55\u8868\u4efb\u52a1\u5904\u7406\u91cf update_task_record_end \u66f4\u65b0\u5f53\u524d\u722c\u866b\u7ed3\u675f delete_task \u5220\u9664\u4efb\u52a1 \u521b\u5efa palp create -s baidu 3 \u8bbe\u7f6e \u6ce8\u610f\uff1a\u7d22\u5f15\u662f\u987a\u5e8f\uff0c\u5e94\u8be5\u5c06\u8be5\u4e2d\u95f4\u4ef6\u653e\u5728\u6700\u540e\u4e00\u4e2a # \u542f\u7528\u5219\u4fee\u6539 task \u8868\u4e2d\u5bf9\u5e94\u4efb\u52a1\u7684\u5931\u8d25\u3001\u751f\u6210\u72b6\u6001 REQUEST_MIDDLEWARE = { 1: \"palp.middleware.CycleSpiderRecordMiddleware\", } # \u542f\u7528\u5219\u751f\u6210\u3001\u6c47\u603b record \u8868\u5355\u6279\u6b21\u722c\u53d6\u8bb0\u5f55 SPIDER_MIDDLEWARE = { 1: 'palp.middleware.CycleSpiderRecordMiddleware', } \u7ed3\u6784 import palp class CycleSpider(palp.LocalSpider, palp.CycleSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e spider_table_task_name = f'palp_cycle_task_{spider_name}' # \u4efb\u52a1\u8868 spider_table_record_name = f'palp_cycle_record_{spider_name}' # \u8bb0\u5f55\u8868 def start_requests(self) -> None: self.initialize_all_task_states() # \u91cd\u7f6e\u6240\u6709\u4efb\u52a1\u72b6\u6001\u4e3a 0 # \u83b7\u53d6\u4efb\u52a1\u72b6\u6001\u4e3a 0 \u7684\u4efb\u52a1 for task in self.get_tasks_state0(): print(task) yield palp.RequestGet(url=task['task'], task_id=task['id']) def parse(self, request, response) -> None: print(response) if __name__ == '__main__': CycleSpider.create_mysql_table() # \u5feb\u6377\u521b\u5efa\u8868 CycleSpider.insert_tasks(['https://www.baidu.com', 'https://www.jd.com']) # \u5feb\u6377\u63d2\u5165\u4efb\u52a1 CycleSpider().start() task_id \u6ce8\u610f\u5230\u8fd9\u91cc\u4f20\u9012\u4e86 task_id\uff0c\u90a3\u4e48\u4ec0\u4e48\u65f6\u5019\u4f20\u9012 task_id\uff1f \u9996\u5148\uff1atask_id \u4ee3\u8868 task \u7684 id\uff0cRequest \u4e2d\u4f20\u9012\u5219\u4ee3\u8868\u5f53\u5f53\u524d\u8bf7\u6c42\u6210\u529f\u65f6 == \u4efb\u52a1\u6267\u884c\u6210\u529f\uff0c\u6846\u67b6\u81ea\u5e26\u66f4\u65b0\u72b6\u6001 task \u5b57\u6bb5\u5c31\u662f\u4e00\u4e2a url\uff0c\u8bf7\u6c42\u6210\u529f\u89c6\u4e3a\u6267\u884c\u6210\u529f task \u5b57\u6bb5\u4e0d\u662f url\uff0c\u90a3\u4e48\u5c31\u4e0d\u9700\u8981 task_id \u5b57\u6bb5\uff0c\u53ea\u6709\u5728\u4f60\u89c9\u5f97\u8fd9\u4e2a task \u6267\u884c\u7ed3\u675f\u65f6\u8c03\u7528\u4ee5\u4e0b\u4ee3\u7801\uff08\u6bd4\u5982 pipeline \u6536\u5230\u6307\u5b9a\u6570\u636e\uff09 spider.set_task_state_done(task_id=xxx) spider.set_task_state_failed(task_id=xxx) CycleSpiderRecordMiddleware \u8be5\u4e2d\u95f4\u4ef6\u4f1a\u8bb0\u5f55\u722c\u866b\u7684\u6267\u884c\u72b6\u6001 spider_start\uff1a \u542f\u52a8\u65f6\u521b\u5efa\u8bb0\u5f55\u8868\u521d\u59cb\u8bb0\u5f55\uff08record \u8868\uff09 request_failed\uff1a \u4f20\u9012 task_id \u65f6\uff0c\u8bb0\u5f55\u5931\u8d25\u7684\u8bf7\u6c42\uff08 task \u8868\uff09 request_close\uff1a \u4f20\u9012 task_id \u65f6\uff0c\u8bb0\u5f55\u6210\u529f\u7684\u8bf7\u6c42\uff08 task \u8868\uff09 request_record\uff1a spider \u7ed3\u675f\u65f6\uff0c\u66f4\u65b0 record \u8868\uff0c\u6c47\u603b\u7ed3\u679c \u5f53\u4f60\u60f3\u4e00\u76f4\u66f4\u65b0 record \u8868\uff0c\u90a3\u4e48\u53ef\u4ee5\u81ea\u5df1\u53bb\u5199\u5b9e\u73b0\uff0c\u53ea\u9700\u8c03\u7528 CycleSpider \u7684\u65b9\u6cd5\u5373\u53ef JumpSpider \u8fd9\u662f\u7528\u6765\u89e3\u51b3\u9891\u7e41\u7684\u767b\u5f55\u3001\u9a8c\u8bc1\u7684\uff0c\u907f\u514d\u903b\u8f91\u6df7\u4e71 \u8be5 spider \u548c\u5176\u4f59 spider \u6ca1\u6709\u5173\u7cfb\uff0c\u4e0d\u8d70\u4efb\u4f55\u4e2d\u95f4\u4ef6\uff0c\u662f\u5b8c\u5168\u72ec\u7acb\u7684 \u8be5 spider \u542b\u6709\u4ee5\u4e0b\u65b9\u6cd5 spider_start\uff1a\u6267\u884c\u5f00\u59cb\u65f6\u7684\u65b9\u6cd5 spider_close\uff1a\u6267\u884c\u7ed3\u675f\u65f6\u7684\u65b9\u6cd5 jump_out\uff1a\u81ea\u52a8\u5408\u5e76 cookie\u3001meta\uff08\u53ef\u6839\u636e\u9700\u6c42\u91cd\u5199\uff09 \u6ce8\u610f\uff1a spider \u8fd0\u884c\u9519\u8bef\u65f6\uff0c\u5c06\u4f1a\u5c06\u8f93\u5165\u8bf7\u6c42\u653e\u5165 redis \u5931\u8d25\u961f\u5217\uff08\u5206\u5e03\u5f0f\u65f6\uff0c\u9700\u5f00\u542f\u5bf9\u5e94\u8bbe\u7f6e\uff09 \u521b\u5efa palp create baidu 4 \u4f7f\u7528 JumpSpider \u5185\u6ce8\u610f\u5224\u65ad\u72b6\u6001 \u4e0d\u6b63\u5e38\u7684\u65f6\u5019\u53ef\u4ee5 yield \u539f\u59cb\u8bf7\u6c42\uff0c\u8fbe\u5230\u5faa\u73af\u7684\u76ee\u7684\uff0c\u76f4\u5230\u8fbe\u5230\u6211\u4eec\u7684\u9700\u6c42\uff0c\u518d\u53bb\u6267\u884c\u6b63\u5e38\u4ee3\u7801 \u3010\u793a\u4f8b\u3011 yield RequestGet( url='xx', jump_spider='xxx', # \u5bfc\u5165 JumpSpider\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 jump_spider_kwargs={}, # \u5bfc\u5165\u7684\u53c2\u6570 JumpSpider \u4e2d self.xxx \u8bbf\u95ee jump_request_middleware='xxx', # \u5bfc\u5165\u8bf7\u6c42\u4e2d\u95f4\u4ef6\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 callback='xxx' ) \u542f\u52a8\u722c\u866b \u722c\u866b\u5185\u542f\u52a8 BaiduSpider(thread_count=1).start() # \u542f\u52a8\u53ef\u9009\u53c2\u6570\u770b\u6e90\u7801 \u542f\u52a8\u6587\u4ef6\u542f\u52a8 \u6ce8\u610f\uff1a\u662f\u8fdb\u7a0b\u5f62\u5f0f\u542f\u52a8\uff0c\u63a8\u8350\u76f4\u63a5\u4f7f\u7528 start.py \u5373\u53ef\uff0c\u53ef\u540c\u65f6\u542f\u52a8\u591a\u4e2a\u722c\u866b \u53c2\u6570\u4ecb\u7ecd spider_name\uff1a\u722c\u866b\u540d\uff08spider \u5185\u4e00\u81f4\uff09 count\uff1a\u542f\u52a8\u591a\u5c11\u4e2a\u5b9e\u4f8b\uff08\u53ef\u5b9e\u73b0\u5355\u673a\u5206\u5e03\u5f0f\uff0c\u5c31\u662f\u8fdb\u7a0b\u542f\u52a8\u591a\u5c11\u4e2a\uff09 **kwargs\uff1a\u722c\u866b\u542f\u52a8\u53c2\u6570\uff0c\u540c spider \u7684\u542f\u52a8\u53c2\u6570 \u3010\u793a\u4f8b\u3011 from palp import start_spider def main(): start_spider.execute(spider_name='xxx', count=1) if __name__ == '__main__': main()","title":"Spider"},{"location":"spider/#spider","text":"\u76ee\u524d\u63d0\u4f9b\u4ee5\u4e0b spider LocalSpider\uff1a\u672c\u5730\u722c\u866b DistributiveSpider\uff1a\u5206\u5e03\u5f0f\u722c\u866b CycleSpider\uff1a\u5468\u671f\u722c\u866b\uff08\u6839\u636e\u9700\u6c42\u53ef\u7ee7\u627f\u672c\u5730\u3001\u5206\u5e03\u5f0f\uff09 JumpSpider\uff1a\u8df3\u8f6c\u722c\u866b\uff08\u57fa\u4e8e\u5185\u5b58\u961f\u5217\uff0c\u7528\u4e8e\u9891\u7e41\u7684\u9a8c\u8bc1\u7801\u3001\u767b\u5f55\u7684\u786e\u8ba4\u66f4\u65b0 cookie\uff09","title":"Spider"},{"location":"spider/#localspider","text":"\u672c\u5730\u722c\u866b\uff0c\u4e0d\u652f\u6301\u5206\u5e03\u5f0f","title":"LocalSpider"},{"location":"spider/#_1","text":"\u6ce8\u610f\uff1a\u5728\u9879\u76ee\u76ee\u5f55\u4e0b\u6267\u884c palp create -s baidu 1","title":"\u521b\u5efa"},{"location":"spider/#_2","text":"\"\"\" Create on 2022-12-12 16:21:10.159221 ---------- @summary: ---------- @author: \"\"\" import palp class BaiduSpider(palp.LocalSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e def start_requests(self) -> None: \"\"\" \u8d77\u59cb\u51fd\u6570 :return: \"\"\" yield palp.RequestGet(\"https://www.baidu.com\") def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" print(response) if __name__ == '__main__': BaiduSpider().start()","title":"\u7ed3\u6784"},{"location":"spider/#distributivespider","text":"\u6ce8\u610f\uff1a \u5206\u5e03\u5f0f\u722c\u866b\uff0c\u9700\u8981\u5728\u8bbe\u7f6e\u4e2d\u589e\u52a0 redis \u8fde\u63a5 \u5206\u5e03\u5f0f\u722c\u866b\u9ed8\u8ba4\u4e3a\u4f18\u5148\u7ea7\u961f\u5217\uff0c\u672c\u8eab\u5177\u6709\u53bb\u91cd\u7684\u529f\u80fd\uff0c\u5982\u679c\u6709\u5927\u91cf\u5fc5\u8981\u7684\u91cd\u590d\u8bf7\u6c42\uff0c\u4fee\u6539 settings.REQUEST_QUEUE_MODE = 1","title":"DistributiveSpider"},{"location":"spider/#_3","text":"palp create -s baidu 2","title":"\u521b\u5efa"},{"location":"spider/#_4","text":"\u548c\u666e\u901a\u7684\u722c\u866b\uff0c\u53ea\u662f\u7ee7\u627f\u7c7b\u4e0d\u540c\uff0c\u65e0\u6210\u672c\u5207\u6362 \"\"\" Create on 2022-12-12 16:21:10.159221 ---------- @summary: ---------- @author: \"\"\" import palp class BaiduSpider(palp.DistributiveSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e def start_requests(self) -> None: \"\"\" \u8d77\u59cb\u51fd\u6570 :return: \"\"\" yield palp.RequestGet(\"https://www.baidu.com\") def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" print(response) if __name__ == '__main__': BaiduSpider().start()","title":"\u7ed3\u6784"},{"location":"spider/#borrow_requestrecycle_request","text":"\u76ee\u524d\u6846\u67b6\u662f\u6839\u636e\u4ee5\u4e0a\u4e24\u4e2a\u51fd\u6570\u5b9e\u73b0 cookie_jar \u5171\u4eab\u529f\u80fd\uff08\u53ef\u81ea\u5b9a\u4e49\uff09 borrow_request\uff1a\u51b3\u5b9a\u5728\u4ec0\u4e48\u65f6\u5019\u501f\u7528\u5171\u4eab\u7684\u53c2\u6570 recycle_request\uff1a\u51b3\u5b9a\u5728\u6267\u884c\u5b8c\u6bd5\u65f6\uff0c\u5171\u4eab\u4ec0\u4e48\u53c2\u6570 \u5728\u5904\u7406\u6279\u6b21\u4efb\u52a1\u65f6\uff0c\u53ef\u80fd\u4e00\u6b21\u4f1a\u6709\u5f88\u591a\u4efb\u52a1\uff0c\u5bf9\u6bcf\u4e2a\u4efb\u52a1\u90fd\u53bb\u91cd\u65b0\u8bf7\u6c42\uff0c\u83b7\u53d6 cookie \u7684\u8bdd\uff08\u6307\u7684\u662f\u767b\u5f55\u3001\u9a8c\u8bc1\u7801\u7b49\u83b7\u53d6\u5fc5\u8981 cookie\uff09\u5c06\u4f1a\u662f\u707e\u96be \u6240\u4ee5\u8fd9\u91cc\u89e3\u51b3 cookie \u590d\u7528\uff0c\u5f53\u7136\u8981\u505a\u597d cookie \u5931\u6548\u7684\u5224\u65ad\uff0c\u5e76\u91cd\u65b0\u767b\u5f55\uff08\u53ef\u5728 middleware \u5224\u65ad\uff0c\u5e76\u76f4\u63a5\u8fd4\u56de\u542b\u6709 jumpspider \u7684\u8bf7\u6c42\uff09","title":"borrow_request\u3001recycle_request"},{"location":"spider/#settings","text":"REQUEST_BORROW = False # \u5206\u53d1\u5927\u91cf\u4efb\u52a1\u65f6\uff0c\u9700\u8981\u5728\u8bf7\u6c42\u4e2d\u4f20\u9012\u7684\u53c2\u6570\uff08\u9ed8\u8ba4\u56de\u6536 cookie \u590d\u7528\uff09 REQUEST_BORROW_DELETE_WHEN_START = True # \u542f\u52a8\u65f6\u5220\u9664\u6240\u6709 BORROW\uff08\u975e\u5206\u5e03\u5f0f\u662f\u5728\u5185\u5b58\u91cc\uff0c\u8be5\u9009\u9879\u5ffd\u7565\uff09","title":"settings \u5f00\u542f"},{"location":"spider/#spider_1","text":"\u56e0\u4e3a spider \u5185\u65e0\u6cd5\u5224\u65ad\u662f\u5426\u662f\u6700\u540e\u4e00\u4e2a\u8bf7\u6c42\uff0c\u6240\u4ee5\u9700\u8981\u4e3b\u52a8\u56de\u6536 self.recycle_request(request=request)","title":"spider \u56de\u6536"},{"location":"spider/#middleware","text":"\u6ce8\u610f\uff1a\u8fd9\u53ea\u662f\u4e2a\u6848\u4f8b \u8be5\u6848\u4f8b\u662f\u5728\u8bf7\u6c42\u7ed3\u675f\u65f6\uff0c\u5224\u65ad\u5230\u5f53\u524d\u72b6\u6001\u4e0d\u5bf9\uff0c\u968f\u540e\u4fee\u6539\u8bf7\u6c42\uff0c\u8df3\u8f6c\u767b\u5f55\uff0c\u653e\u5f03\u539f\u8bf7\u6c42\u7684\u540c\u65f6\uff0c\u53d1\u51fa\u65b0\u7684\u8bf7\u6c42 def request_close(self, spider, request, response): if response.status_code != 200: request.jump_spider = LoginJumpSpider request.jump_request_middleware = ProxyRequestMiddleware return request","title":"middleware \u5224\u65ad"},{"location":"spider/#_5","text":"\"\"\" Create on 2023-01-03 10:45:25.681820 ---------- @summary: ---------- @author: \"\"\" import palp class BaiduLocalSpider(palp.DistributiveSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e def start_requests(self) -> None: \"\"\" \u8d77\u59cb\u51fd\u6570 :return: \"\"\" yield palp.RequestGet(\"https://www.baidu.com\", keep_cookie=True) yield palp.RequestGet(\"https://www.baidu.com\", keep_cookie=True) def parse(self, request, response) -> None: \"\"\" \u89e3\u6790\u51fd\u6570 :param request: :param response: :return: \"\"\" print(request.cookie_jar.get_cookie()) # \u53ef\u4ee5\u770b\u5230\u4e24\u6b21\u662f\u4e00\u6837\u7684 cookie self.recycle_request(request=request) if __name__ == '__main__': BaiduLocalSpider(thread_count=1).start()","title":"\u6848\u4f8b"},{"location":"spider/#cyclespider","text":"\u5468\u671f\u722c\u866b\uff0c\u4f7f\u7528 mysql \u521b\u5efa\u4efb\u52a1\u8868\uff0c\u5e76\u5728\u722c\u866b\u5185\u90e8\u83b7\u53d6\u8fdb\u884c\u6293\u53d6 \u4e2a\u4eba\u8ba4\u4e3a\uff0c\u4efb\u52a1\u9700\u6c42\u662f\u591a\u6837\u5316\u7684\uff0c\u6240\u4ee5\u4efb\u52a1\u8868\u7684 task \u5b57\u6bb5\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u5e76\u4e14\u83b7\u53d6\u7684\u4efb\u52a1\u662f\u5168\u8868\u5b57\u6bb5\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u81ea\u5b9a\u4e49\u90e8\u5206\u8868\u5b57\u6bb5\uff0c\u5b9e\u73b0\u66f4\u591a\u9700\u6c42 \u6ce8\u610f\uff1a \u7ee7\u627f\u5468\u671f\u722c\u866b\u7684\u3010\u540c\u65f6\u9700\u8981\u7ee7\u627f \u5206\u5e03\u5f0f \u6216 \u672c\u5730\u722c\u866b\u3011\u624d\u53ef\u4ee5\u6267\u884c \u624b\u52a8\u5bfc\u5165\u4e2d\u95f4\u4ef6\uff1apalp.middleware.CycleSpiderRecordMiddleware\uff08\u4e0d\u9700\u8981 record \u8868\uff0c\u4e0d\u9700\u8981\u4f20\u9012 task_id \u65f6\u6846\u67b6\u8bbe\u7f6e\u5df2\u722c\u53d6\uff0c\u53ef\u4ee5\u4e0d\u8981\uff0c\u81ea\u5df1\u7ef4\u62a4\u5c31\u884c\u4e86\uff09 \u8bb0\u5f55\u4e2d\u95f4\u4ef6\u4f1a\uff1a\u81ea\u52a8\u4fee\u6539\u5931\u8d25\u3001\u6210\u529f\u7684\u4efb\u52a1\u72b6\u6001\uff08request \u4f20\u9012 task_id \u65f6\uff0c\u6216\u81ea\u5df1\u8c03\u7528\uff09 \u8bb0\u5f55\u4e2d\u95f4\u4ef6\u4f1a\uff1a\u81ea\u52a8\u5728\u8bb0\u5f55\u8868\u4e2d\u6dfb\u52a0\u3001\u4fee\u6539\u4efb\u52a1\u6267\u884c\u60c5\u51b5 \u542b\u6709\u4ee5\u4e0b\u65b9\u6cd5\uff1a \u65b9\u6cd5 \u8bf4\u660e initialize_all_task_states \u91cd\u7f6e\u6240\u6709\u4efb\u52a1\u72b6\u6001\u4e3a 0 get_tasks \u6839\u636e\u6307\u5b9a\u72b6\u6001\u83b7\u53d6\u4efb\u52a1 get_tasks_state0 \u83b7\u53d6\u72b6\u6001\u4e3a 0 \u7684\u4efb\u52a1 get_tasks_state2 \u83b7\u53d6\u72b6\u6001\u4e3a 2 \u7684\u4efb\u52a1 set_task_state \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u7684\u72b6\u6001 set_task_state_running \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u72b6\u6001\u4e3a 1 set_task_state_done \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u72b6\u6001\u4e3a 2 set_task_state_failed \u8bbe\u7f6e\u6307\u5b9a\u4efb\u52a1\u72b6\u6001\u4e3a 3 create_mysql_table \u521b\u5efa\u4efb\u52a1\u8868\u3001\u8bb0\u5f55\u8868 check_mysql_table_exists \u68c0\u67e5\u8868\u662f\u5426\u5b58\u5728 insert_tasks \u63d2\u5165\u4efb\u52a1\uff08\u5b57\u7b26\u4e32\u6216\u5b57\u7b26\u4e32\u5217\u8868\uff09 insert_task_record_start \u521b\u5efa\u8bb0\u5f55\u8868\u7684\u521d\u59cb\u8bb0\u5f55 update_task_record \u66f4\u65b0\u8bb0\u5f55\u8868\u4efb\u52a1\u5904\u7406\u91cf update_task_record_end \u66f4\u65b0\u5f53\u524d\u722c\u866b\u7ed3\u675f delete_task \u5220\u9664\u4efb\u52a1","title":"CycleSpider"},{"location":"spider/#_6","text":"palp create -s baidu 3","title":"\u521b\u5efa"},{"location":"spider/#_7","text":"\u6ce8\u610f\uff1a\u7d22\u5f15\u662f\u987a\u5e8f\uff0c\u5e94\u8be5\u5c06\u8be5\u4e2d\u95f4\u4ef6\u653e\u5728\u6700\u540e\u4e00\u4e2a # \u542f\u7528\u5219\u4fee\u6539 task \u8868\u4e2d\u5bf9\u5e94\u4efb\u52a1\u7684\u5931\u8d25\u3001\u751f\u6210\u72b6\u6001 REQUEST_MIDDLEWARE = { 1: \"palp.middleware.CycleSpiderRecordMiddleware\", } # \u542f\u7528\u5219\u751f\u6210\u3001\u6c47\u603b record \u8868\u5355\u6279\u6b21\u722c\u53d6\u8bb0\u5f55 SPIDER_MIDDLEWARE = { 1: 'palp.middleware.CycleSpiderRecordMiddleware', }","title":"\u8bbe\u7f6e"},{"location":"spider/#_8","text":"import palp class CycleSpider(palp.LocalSpider, palp.CycleSpider): spider_name = \"baidu\" # \u81ea\u5b9a\u4e49\u7684\u540d\u5b57 spider_domains = [] # \u5141\u8bb8\u901a\u8fc7\u7684\u57df\u540d\uff0c\u9ed8\u8ba4\u4e0d\u9650\u5236 spider_settings = None # \u5b57\u5178\u5f62\u5f0f\u6216\u5bfc\u5165\u5f62\u5f0f\u7684\u8bbe\u7f6e spider_table_task_name = f'palp_cycle_task_{spider_name}' # \u4efb\u52a1\u8868 spider_table_record_name = f'palp_cycle_record_{spider_name}' # \u8bb0\u5f55\u8868 def start_requests(self) -> None: self.initialize_all_task_states() # \u91cd\u7f6e\u6240\u6709\u4efb\u52a1\u72b6\u6001\u4e3a 0 # \u83b7\u53d6\u4efb\u52a1\u72b6\u6001\u4e3a 0 \u7684\u4efb\u52a1 for task in self.get_tasks_state0(): print(task) yield palp.RequestGet(url=task['task'], task_id=task['id']) def parse(self, request, response) -> None: print(response) if __name__ == '__main__': CycleSpider.create_mysql_table() # \u5feb\u6377\u521b\u5efa\u8868 CycleSpider.insert_tasks(['https://www.baidu.com', 'https://www.jd.com']) # \u5feb\u6377\u63d2\u5165\u4efb\u52a1 CycleSpider().start()","title":"\u7ed3\u6784"},{"location":"spider/#task_id","text":"\u6ce8\u610f\u5230\u8fd9\u91cc\u4f20\u9012\u4e86 task_id\uff0c\u90a3\u4e48\u4ec0\u4e48\u65f6\u5019\u4f20\u9012 task_id\uff1f \u9996\u5148\uff1atask_id \u4ee3\u8868 task \u7684 id\uff0cRequest \u4e2d\u4f20\u9012\u5219\u4ee3\u8868\u5f53\u5f53\u524d\u8bf7\u6c42\u6210\u529f\u65f6 == \u4efb\u52a1\u6267\u884c\u6210\u529f\uff0c\u6846\u67b6\u81ea\u5e26\u66f4\u65b0\u72b6\u6001 task \u5b57\u6bb5\u5c31\u662f\u4e00\u4e2a url\uff0c\u8bf7\u6c42\u6210\u529f\u89c6\u4e3a\u6267\u884c\u6210\u529f task \u5b57\u6bb5\u4e0d\u662f url\uff0c\u90a3\u4e48\u5c31\u4e0d\u9700\u8981 task_id \u5b57\u6bb5\uff0c\u53ea\u6709\u5728\u4f60\u89c9\u5f97\u8fd9\u4e2a task \u6267\u884c\u7ed3\u675f\u65f6\u8c03\u7528\u4ee5\u4e0b\u4ee3\u7801\uff08\u6bd4\u5982 pipeline \u6536\u5230\u6307\u5b9a\u6570\u636e\uff09 spider.set_task_state_done(task_id=xxx) spider.set_task_state_failed(task_id=xxx)","title":"task_id"},{"location":"spider/#cyclespiderrecordmiddleware","text":"\u8be5\u4e2d\u95f4\u4ef6\u4f1a\u8bb0\u5f55\u722c\u866b\u7684\u6267\u884c\u72b6\u6001 spider_start\uff1a \u542f\u52a8\u65f6\u521b\u5efa\u8bb0\u5f55\u8868\u521d\u59cb\u8bb0\u5f55\uff08record \u8868\uff09 request_failed\uff1a \u4f20\u9012 task_id \u65f6\uff0c\u8bb0\u5f55\u5931\u8d25\u7684\u8bf7\u6c42\uff08 task \u8868\uff09 request_close\uff1a \u4f20\u9012 task_id \u65f6\uff0c\u8bb0\u5f55\u6210\u529f\u7684\u8bf7\u6c42\uff08 task \u8868\uff09 request_record\uff1a spider \u7ed3\u675f\u65f6\uff0c\u66f4\u65b0 record \u8868\uff0c\u6c47\u603b\u7ed3\u679c \u5f53\u4f60\u60f3\u4e00\u76f4\u66f4\u65b0 record \u8868\uff0c\u90a3\u4e48\u53ef\u4ee5\u81ea\u5df1\u53bb\u5199\u5b9e\u73b0\uff0c\u53ea\u9700\u8c03\u7528 CycleSpider \u7684\u65b9\u6cd5\u5373\u53ef","title":"CycleSpiderRecordMiddleware"},{"location":"spider/#jumpspider","text":"\u8fd9\u662f\u7528\u6765\u89e3\u51b3\u9891\u7e41\u7684\u767b\u5f55\u3001\u9a8c\u8bc1\u7684\uff0c\u907f\u514d\u903b\u8f91\u6df7\u4e71 \u8be5 spider \u548c\u5176\u4f59 spider \u6ca1\u6709\u5173\u7cfb\uff0c\u4e0d\u8d70\u4efb\u4f55\u4e2d\u95f4\u4ef6\uff0c\u662f\u5b8c\u5168\u72ec\u7acb\u7684 \u8be5 spider \u542b\u6709\u4ee5\u4e0b\u65b9\u6cd5 spider_start\uff1a\u6267\u884c\u5f00\u59cb\u65f6\u7684\u65b9\u6cd5 spider_close\uff1a\u6267\u884c\u7ed3\u675f\u65f6\u7684\u65b9\u6cd5 jump_out\uff1a\u81ea\u52a8\u5408\u5e76 cookie\u3001meta\uff08\u53ef\u6839\u636e\u9700\u6c42\u91cd\u5199\uff09 \u6ce8\u610f\uff1a spider \u8fd0\u884c\u9519\u8bef\u65f6\uff0c\u5c06\u4f1a\u5c06\u8f93\u5165\u8bf7\u6c42\u653e\u5165 redis \u5931\u8d25\u961f\u5217\uff08\u5206\u5e03\u5f0f\u65f6\uff0c\u9700\u5f00\u542f\u5bf9\u5e94\u8bbe\u7f6e\uff09","title":"JumpSpider"},{"location":"spider/#_9","text":"palp create baidu 4","title":"\u521b\u5efa"},{"location":"spider/#_10","text":"JumpSpider \u5185\u6ce8\u610f\u5224\u65ad\u72b6\u6001 \u4e0d\u6b63\u5e38\u7684\u65f6\u5019\u53ef\u4ee5 yield \u539f\u59cb\u8bf7\u6c42\uff0c\u8fbe\u5230\u5faa\u73af\u7684\u76ee\u7684\uff0c\u76f4\u5230\u8fbe\u5230\u6211\u4eec\u7684\u9700\u6c42\uff0c\u518d\u53bb\u6267\u884c\u6b63\u5e38\u4ee3\u7801 \u3010\u793a\u4f8b\u3011 yield RequestGet( url='xx', jump_spider='xxx', # \u5bfc\u5165 JumpSpider\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 jump_spider_kwargs={}, # \u5bfc\u5165\u7684\u53c2\u6570 JumpSpider \u4e2d self.xxx \u8bbf\u95ee jump_request_middleware='xxx', # \u5bfc\u5165\u8bf7\u6c42\u4e2d\u95f4\u4ef6\uff08\u4e0d\u9700\u8981\u5b9e\u4f8b\u5316\uff09 callback='xxx' )","title":"\u4f7f\u7528"},{"location":"spider/#_11","text":"","title":"\u542f\u52a8\u722c\u866b"},{"location":"spider/#_12","text":"BaiduSpider(thread_count=1).start() # \u542f\u52a8\u53ef\u9009\u53c2\u6570\u770b\u6e90\u7801","title":"\u722c\u866b\u5185\u542f\u52a8"},{"location":"spider/#_13","text":"\u6ce8\u610f\uff1a\u662f\u8fdb\u7a0b\u5f62\u5f0f\u542f\u52a8\uff0c\u63a8\u8350\u76f4\u63a5\u4f7f\u7528 start.py \u5373\u53ef\uff0c\u53ef\u540c\u65f6\u542f\u52a8\u591a\u4e2a\u722c\u866b \u53c2\u6570\u4ecb\u7ecd spider_name\uff1a\u722c\u866b\u540d\uff08spider \u5185\u4e00\u81f4\uff09 count\uff1a\u542f\u52a8\u591a\u5c11\u4e2a\u5b9e\u4f8b\uff08\u53ef\u5b9e\u73b0\u5355\u673a\u5206\u5e03\u5f0f\uff0c\u5c31\u662f\u8fdb\u7a0b\u542f\u52a8\u591a\u5c11\u4e2a\uff09 **kwargs\uff1a\u722c\u866b\u542f\u52a8\u53c2\u6570\uff0c\u540c spider \u7684\u542f\u52a8\u53c2\u6570 \u3010\u793a\u4f8b\u3011 from palp import start_spider def main(): start_spider.execute(spider_name='xxx', count=1) if __name__ == '__main__': main()","title":"\u542f\u52a8\u6587\u4ef6\u542f\u52a8"},{"location":"tool/","text":"Tool Alarm \u57fa\u4e8e gsender \u6a21\u5757\u7684\u5185\u7f6e\u62a5\u8b66 \u63d0\u4f9b\u4e24\u4e2a\u51fd\u6570 send_email\uff1a\u53d1\u9001\u90ae\u4ef6 send_dingtalk\uff1a\u652f\u6301\u6240\u6709\u9489\u9489\u7fa4\u804a\u6d88\u606f\u7c7b\u578b \u6ce8\u610f\uff1a \u6a21\u5757\u9700\u8981\u4e3b\u52a8\u8c03\u7528 \u9489\u9489\u6d88\u606f\u8003\u8651\u5230\u6a21\u677f\u8f83\u591a\uff0c\u6240\u4ee5\u8fd4\u56de\u7684\u662f DingTalkSender \u5bf9\u8c61\uff0c\u518d\u53bb\u8c03\u7528\u5bf9\u5e94\u7684\u53d1\u9001\u65b9\u6cd5 \u8bbe\u7f6e # \u9884\u8b66\uff1aEmail EMAIL_USER = None # Email \u8d26\u53f7 EMAIL_PWD = None # Email \u6388\u6743\u7801 # \u9884\u8b66\uff1aDingTalk DING_TALK_SECRET = None # \u52a0\u7b7e DING_TALK_ACCESS_TOKEN = None # webhook \u94fe\u63a5\u5185\u7684 access_token \u793a\u4f8b \u57fa\u672c\u4f7f\u7528 import palp palp.send_email(receiver='xxx', content_text='palp \u6267\u884c\u7ed3\u675f') palp.send_dingtalk().send_text(content='\u6d4b\u8bd5\u6d88\u606f') \u5b9e\u9645\u6848\u4f8b \u6bd4\u5982\u5728 middleware \u4e2d\u7684 request_record \u4e2d\u53d1\u9001\u5904\u7406\u7ed3\u679c def request_record(self, spider, record: dict) -> None: \"\"\" \u8bf7\u6c42\u7ed3\u679c\u8bb0\u5f55\uff08\u5728 spider \u7ed3\u675f\u65f6\u8c03\u7528\uff09 :param spider: :param record: {'all': 0, 'failed': 0, 'succeed': 0} \u6837\u5f0f\u7684\u5b57\u5178 :return: \"\"\" request_all = record['all'] request_failed = record['failed'] request_succeed = record['succeed'] palp.send_dingtalk().send_text( content=f'\u6267\u884c\u5b8c\u6bd5\uff0c\u5f53\u524d\u5904\u7406\u60c5\u51b5\uff1a\\n\u603b\u91cf\uff1a{request_all}\\n\u5931\u8d25\u91cf\uff1a{request_failed}\\n\u6210\u529f\u91cf\uff1a{request_succeed}' ) Checker \u6839\u636e\u4e00\u5b9a\u6761\u4ef6\u63a7\u5236\u722c\u866b\u6682\u505c\u3001\u505c\u6b62\u8fd0\u884c \u53c2\u6570 \u53ef\u914d\u7f6e\u53c2\u6570\uff1a check_time\uff1a\u68c0\u67e5\u7684\u9891\u7387\uff0c\u9ed8\u8ba4 3s failed_limit\uff1a\u68c0\u67e5\u7684\u5bb9\u9519\uff0c\u9ed8\u8ba4 3 \u6b21\uff0c\u8fde\u7eed 3 \u6b21\u5c31\u6267\u884c\u5bf9\u5e94\u51fd\u6570 \u4fee\u6539 Checker.check_time = 1 Checker.failed_limit = 1 \u81ea\u5b9a\u4e49 need_stop \u4ec5\u9700\u91cd\u5199 need_stop \u65b9\u6cd5\uff0c\u5e76\u8fd4\u56de bool \u6ce8\u610f\uff1a\u8be5\u51fd\u6570\u5982\u679c\u4ea7\u751f\u4efb\u4f55\u62a5\u9519\uff0c\u5c06\u89c6\u4e3a True \u9700\u8981\u6682\u505c\u3001\u505c\u6b62\uff0c\u6240\u4ee5\u8981\u505a\u597d\u5904\u7406 class Checker(palp.Checker): @classmethod def need_stop(cls) -> bool: return True # \u4f55\u65f6\u9700\u8981\u505c\u6b62 \u8c03\u7528 \u4e00\u822c\u5728 request_in \u65f6\u4f7f\u7528\uff0c\u76f4\u63a5\u963b\u65ad\u6240\u6709\u65b0\u8bf7\u6c42 \u53ef\u9009\u51fd\u6570\uff1a check_and_wait\uff1a\u5f53\u8fde\u7eed\u9519\u8bef\u8fbe\u5230 failed_limit \u4e4b\u540e\uff0c\u963b\u62e6\u6240\u6709\u8bf7\u6c42\uff0c\u76f4\u5230\u91ca\u653e check_and_stop\uff1a\u5f53\u8fde\u7eed\u9519\u8bef\u8fbe\u5230 failed_limit \u4e4b\u540e\uff0c\u505c\u6b62\u6240\u6709\u65b0\u8bf7\u6c42\u7684\u5904\u7406\uff08\u4e00\u65e6\u4e2d\u65ad\u65e0\u6cd5\u633d\u56de\uff0c\u53ea\u80fd\u91cd\u542f\uff09 stop_spider\uff1a\u505c\u6b62\u6240\u6709\u65b0\u8bf7\u6c42\u7684\u5904\u7406\uff08\u4f7f\u7528\u4ee5\u4e0a\u65b9\u6cd5\uff0c\u4e0d\u9700\u8981\u4e3b\u52a8\u8c03\u7528\uff09 \u6ce8\u610f\uff1a \u5185\u90e8\u662f\u8c03\u7528\u7684 _need_stop() \u51fd\u6570\uff0c\u6240\u4ee5\u53ef\u4ee5\u63a7\u5236\u9891\u7387\u3001\u5bb9\u9519 \u8fd9\u91cc\u7684\u505c\u6b62\u662f\u6e29\u548c\u7684\uff0c\u53ea\u662f\u963b\u65ad\u65b0\u8bf7\u6c42\u4ece\u961f\u5217\u4e2d\u63a5\u6536 check_and_wait \u7684 timeout \u975e\u7cbe\u786e\u65f6\u95f4\uff0c\u53d7 check_time \u5f71\u54cd\u4f1a\u6709\u4e00\u5b9a\u8bef\u5dee \u6848\u4f8b \u5f53\u767e\u5ea6\u8bbf\u95ee\u72b6\u6001\u7801\u4e0d\u662f 200 \u65f6\uff0c\u5c06\u4f1a\u505c\u6b62 spider \u51fd\u6570\u6267\u884c\uff0c\u76f4\u5230\u8bbf\u95ee\u662f 200 class Checker(palp.Checker): check_time = 3 # \u591a\u5c11 s \u68c0\u67e5\u4e00\u6b21 failed_limit = 3 # \u8fde\u7eed\u591a\u5c11\u6b21\u5c31\u6267\u884c wait\u3001stop @classmethod def need_stop(cls) -> bool: if requests.get('http://www.baidu.com').status_code != 200: return True return False class CheckRequestMiddleware(palp.RequestMiddleware): def request_in(self, spider, request) -> None: Checker.check_and_wait(spider=spider) # \u8fde\u7eed 3 \u6b21\u5931\u8d25\u5c06\u4f1a\u963b\u62e6\u6240\u6709\u8bf7\u6c42\uff0c\u76f4\u5230\u72b6\u6001\u6062\u590d Checker.check_and_wait(spider=spider, timeout=1*60*60) # \u8fde\u7eed 3 \u6b21\u5931\u8d25\u5c06\u4f1a\u963b\u62e6\u6240\u6709\u8bf7\u6c42\uff0c\u8fbe\u5230\u6307\u5b9a\u8d85\u65f6\u65f6\u95f4\u505c\u6b62 spider\uff0c\u907f\u514d\u6b7b\u5faa\u73af Checker.check_and_stop(spider=spider) # \u8fde\u7eed 3 \u6b21\u5931\u8d25\u5c06\u4f1a\u505c\u6b62 spider \u6267\u884c","title":"Tool"},{"location":"tool/#tool","text":"","title":"Tool"},{"location":"tool/#alarm","text":"\u57fa\u4e8e gsender \u6a21\u5757\u7684\u5185\u7f6e\u62a5\u8b66 \u63d0\u4f9b\u4e24\u4e2a\u51fd\u6570 send_email\uff1a\u53d1\u9001\u90ae\u4ef6 send_dingtalk\uff1a\u652f\u6301\u6240\u6709\u9489\u9489\u7fa4\u804a\u6d88\u606f\u7c7b\u578b \u6ce8\u610f\uff1a \u6a21\u5757\u9700\u8981\u4e3b\u52a8\u8c03\u7528 \u9489\u9489\u6d88\u606f\u8003\u8651\u5230\u6a21\u677f\u8f83\u591a\uff0c\u6240\u4ee5\u8fd4\u56de\u7684\u662f DingTalkSender \u5bf9\u8c61\uff0c\u518d\u53bb\u8c03\u7528\u5bf9\u5e94\u7684\u53d1\u9001\u65b9\u6cd5","title":"Alarm"},{"location":"tool/#_1","text":"# \u9884\u8b66\uff1aEmail EMAIL_USER = None # Email \u8d26\u53f7 EMAIL_PWD = None # Email \u6388\u6743\u7801 # \u9884\u8b66\uff1aDingTalk DING_TALK_SECRET = None # \u52a0\u7b7e DING_TALK_ACCESS_TOKEN = None # webhook \u94fe\u63a5\u5185\u7684 access_token","title":"\u8bbe\u7f6e"},{"location":"tool/#_2","text":"","title":"\u793a\u4f8b"},{"location":"tool/#_3","text":"import palp palp.send_email(receiver='xxx', content_text='palp \u6267\u884c\u7ed3\u675f') palp.send_dingtalk().send_text(content='\u6d4b\u8bd5\u6d88\u606f')","title":"\u57fa\u672c\u4f7f\u7528"},{"location":"tool/#_4","text":"\u6bd4\u5982\u5728 middleware \u4e2d\u7684 request_record \u4e2d\u53d1\u9001\u5904\u7406\u7ed3\u679c def request_record(self, spider, record: dict) -> None: \"\"\" \u8bf7\u6c42\u7ed3\u679c\u8bb0\u5f55\uff08\u5728 spider \u7ed3\u675f\u65f6\u8c03\u7528\uff09 :param spider: :param record: {'all': 0, 'failed': 0, 'succeed': 0} \u6837\u5f0f\u7684\u5b57\u5178 :return: \"\"\" request_all = record['all'] request_failed = record['failed'] request_succeed = record['succeed'] palp.send_dingtalk().send_text( content=f'\u6267\u884c\u5b8c\u6bd5\uff0c\u5f53\u524d\u5904\u7406\u60c5\u51b5\uff1a\\n\u603b\u91cf\uff1a{request_all}\\n\u5931\u8d25\u91cf\uff1a{request_failed}\\n\u6210\u529f\u91cf\uff1a{request_succeed}' )","title":"\u5b9e\u9645\u6848\u4f8b"},{"location":"tool/#checker","text":"\u6839\u636e\u4e00\u5b9a\u6761\u4ef6\u63a7\u5236\u722c\u866b\u6682\u505c\u3001\u505c\u6b62\u8fd0\u884c","title":"Checker"},{"location":"tool/#_5","text":"\u53ef\u914d\u7f6e\u53c2\u6570\uff1a check_time\uff1a\u68c0\u67e5\u7684\u9891\u7387\uff0c\u9ed8\u8ba4 3s failed_limit\uff1a\u68c0\u67e5\u7684\u5bb9\u9519\uff0c\u9ed8\u8ba4 3 \u6b21\uff0c\u8fde\u7eed 3 \u6b21\u5c31\u6267\u884c\u5bf9\u5e94\u51fd\u6570 \u4fee\u6539 Checker.check_time = 1 Checker.failed_limit = 1","title":"\u53c2\u6570"},{"location":"tool/#need_stop","text":"\u4ec5\u9700\u91cd\u5199 need_stop \u65b9\u6cd5\uff0c\u5e76\u8fd4\u56de bool \u6ce8\u610f\uff1a\u8be5\u51fd\u6570\u5982\u679c\u4ea7\u751f\u4efb\u4f55\u62a5\u9519\uff0c\u5c06\u89c6\u4e3a True \u9700\u8981\u6682\u505c\u3001\u505c\u6b62\uff0c\u6240\u4ee5\u8981\u505a\u597d\u5904\u7406 class Checker(palp.Checker): @classmethod def need_stop(cls) -> bool: return True # \u4f55\u65f6\u9700\u8981\u505c\u6b62","title":"\u81ea\u5b9a\u4e49 need_stop"},{"location":"tool/#_6","text":"\u4e00\u822c\u5728 request_in \u65f6\u4f7f\u7528\uff0c\u76f4\u63a5\u963b\u65ad\u6240\u6709\u65b0\u8bf7\u6c42 \u53ef\u9009\u51fd\u6570\uff1a check_and_wait\uff1a\u5f53\u8fde\u7eed\u9519\u8bef\u8fbe\u5230 failed_limit \u4e4b\u540e\uff0c\u963b\u62e6\u6240\u6709\u8bf7\u6c42\uff0c\u76f4\u5230\u91ca\u653e check_and_stop\uff1a\u5f53\u8fde\u7eed\u9519\u8bef\u8fbe\u5230 failed_limit \u4e4b\u540e\uff0c\u505c\u6b62\u6240\u6709\u65b0\u8bf7\u6c42\u7684\u5904\u7406\uff08\u4e00\u65e6\u4e2d\u65ad\u65e0\u6cd5\u633d\u56de\uff0c\u53ea\u80fd\u91cd\u542f\uff09 stop_spider\uff1a\u505c\u6b62\u6240\u6709\u65b0\u8bf7\u6c42\u7684\u5904\u7406\uff08\u4f7f\u7528\u4ee5\u4e0a\u65b9\u6cd5\uff0c\u4e0d\u9700\u8981\u4e3b\u52a8\u8c03\u7528\uff09 \u6ce8\u610f\uff1a \u5185\u90e8\u662f\u8c03\u7528\u7684 _need_stop() \u51fd\u6570\uff0c\u6240\u4ee5\u53ef\u4ee5\u63a7\u5236\u9891\u7387\u3001\u5bb9\u9519 \u8fd9\u91cc\u7684\u505c\u6b62\u662f\u6e29\u548c\u7684\uff0c\u53ea\u662f\u963b\u65ad\u65b0\u8bf7\u6c42\u4ece\u961f\u5217\u4e2d\u63a5\u6536 check_and_wait \u7684 timeout \u975e\u7cbe\u786e\u65f6\u95f4\uff0c\u53d7 check_time \u5f71\u54cd\u4f1a\u6709\u4e00\u5b9a\u8bef\u5dee","title":"\u8c03\u7528"},{"location":"tool/#_7","text":"\u5f53\u767e\u5ea6\u8bbf\u95ee\u72b6\u6001\u7801\u4e0d\u662f 200 \u65f6\uff0c\u5c06\u4f1a\u505c\u6b62 spider \u51fd\u6570\u6267\u884c\uff0c\u76f4\u5230\u8bbf\u95ee\u662f 200 class Checker(palp.Checker): check_time = 3 # \u591a\u5c11 s \u68c0\u67e5\u4e00\u6b21 failed_limit = 3 # \u8fde\u7eed\u591a\u5c11\u6b21\u5c31\u6267\u884c wait\u3001stop @classmethod def need_stop(cls) -> bool: if requests.get('http://www.baidu.com').status_code != 200: return True return False class CheckRequestMiddleware(palp.RequestMiddleware): def request_in(self, spider, request) -> None: Checker.check_and_wait(spider=spider) # \u8fde\u7eed 3 \u6b21\u5931\u8d25\u5c06\u4f1a\u963b\u62e6\u6240\u6709\u8bf7\u6c42\uff0c\u76f4\u5230\u72b6\u6001\u6062\u590d Checker.check_and_wait(spider=spider, timeout=1*60*60) # \u8fde\u7eed 3 \u6b21\u5931\u8d25\u5c06\u4f1a\u963b\u62e6\u6240\u6709\u8bf7\u6c42\uff0c\u8fbe\u5230\u6307\u5b9a\u8d85\u65f6\u65f6\u95f4\u505c\u6b62 spider\uff0c\u907f\u514d\u6b7b\u5faa\u73af Checker.check_and_stop(spider=spider) # \u8fde\u7eed 3 \u6b21\u5931\u8d25\u5c06\u4f1a\u505c\u6b62 spider \u6267\u884c","title":"\u6848\u4f8b"}]}